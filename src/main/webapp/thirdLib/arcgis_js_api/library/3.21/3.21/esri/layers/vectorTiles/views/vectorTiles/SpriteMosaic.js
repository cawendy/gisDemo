// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/SpriteMosaic","require exports ./Rect ./GeometryUtils ./RectangleBinPack ../webgl/Texture".split(" "),function(u,v,r,q,l,t){return function(){function e(b,d,a){void 0===a&&(a=0);this._size=[];this._mosaicsData=[];this._textures=[];this._dirties=[];this._pageHeight=this._pageWidth=this._currentPage=this._maxItemSize=0;this._mosaicRects={};this.pixelRatio=1;(0>=b||0>=d)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!");
this._pageWidth=b;this._pageHeight=d;0<a&&(this._maxItemSize=a);this._binPack=new l(b-4,d-4)}e.prototype.getWidth=function(b){return b>=this._size.length?-1:this._size[b][0]};e.prototype.getHeight=function(b){return b>=this._size.length?-1:this._size[b][1]};e.prototype.setSpriteSource=function(b){this.dispose();this.pixelRatio=b.devicePixelRatio;0===this._mosaicsData.length&&(this._binPack=new l(this._pageWidth-4,this._pageHeight-4),this._mosaicsData[0]=new Uint32Array(Math.floor(this._pageWidth)*
Math.floor(this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0));this._sprites=b};e.prototype.getSpriteItem=function(b,d){void 0===d&&(d=!1);var a=this._mosaicRects[b];if(a)return a;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;var c=this._sprites.getSpritePosition(b);if(!c||!c.width||!c.height||0>c.width||0>c.height)return null;var a=this._allocateImage(c.width,c.height),e=a[0],h=a[1],f=a[2];if(0>=e.width)return null;
a={rect:e,width:c.width,height:c.height,sdf:c.sdf,pixelRatio:c.pixelRatio,page:h};this._copy(e,c,h,f,d);return this._mosaicRects[b]=a};e.prototype.preloadSpriteItems=function(){for(var b=0,d=this._sprites.spriteNames;b<d.length;b++)this.getSpriteItem(d[b],!0)};e.prototype.getSpriteItems=function(b){for(var d={},a=0;a<b.length;a++){var c=b[a];d[c]=this.getSpriteItem(c)}return d};e.prototype.getMosaicItemPosition=function(b,d){var a=this.getSpriteItem(b,d),c=a&&a.rect;if(!c)return null;c.width=a.width;
c.height=a.height;return{size:[a.width,a.height],tl:[(c.x+2)/this._size[a.page][0],(c.y+2)/this._size[a.page][1]],br:[(c.x+2+a.width)/this._size[a.page][0],(c.y+2+a.height)/this._size[a.page][1]],page:a.page}};e.prototype.bind=function(b,d,a,c){void 0===a&&(a=0);void 0===c&&(c=0);this._textures[a]||(this._textures[a]=new t(b,{pixelFormat:6408,dataType:5121,width:this._size[a][0],height:this._size[a][1]},new Uint8Array(this._mosaicsData[a].buffer)));var e=this._textures[a];e.setSamplingMode(d);this._dirties[a]&&
e.setData(new Uint8Array(this._mosaicsData[a].buffer));b.bindTexture(e,c);this._dirties[a]=!1};e._copyBits=function(b,d,a,c,e,h,f,g,m,n,k){var p=c*d+a;f=g*h+f;if(k)for(f-=h,k=-1;k<=n;k++,p=((k+n)%n+c)*d+a,f+=h)for(g=-1;g<=m;g++)e[f+g]=b[p+(g+m)%m];else for(k=0;k<n;k++){for(g=0;g<m;g++)e[f+g]=b[p+g];p+=d;f+=h}};e.prototype._copy=function(b,d,a,c,l){if(this._sprites&&"loaded"===this._sprites.loadStatus&&!(a>=this._mosaicsData.length)){var h=new Uint32Array(this._sprites.image.buffer),f=this._mosaicsData[a];
f&&h||console.error("Source or target images are uninitialized!");e._copyBits(h,this._sprites.width,d.x,d.y,f,c[0],b.x+2,b.y+2,d.width,d.height,l);this._dirties[a]=!0}};e.prototype._allocateImage=function(b,d){b+=2;d+=2;var a=Math.max(b,d);if(this._maxItemSize&&this._maxItemSize<a){var a=Math.pow(2,Math.ceil(q.log2(b))),c=Math.pow(2,Math.ceil(q.log2(d))),e=new r(0,0,b,d);this._mosaicsData.push(new Uint32Array(a*c));this._dirties.push(!0);this._size.push([a,c]);this._textures.push(void 0);return[e,
this._mosaicsData.length-1,[a,c]]}a=b%4?4-b%4:4;c=d%4?4-d%4:4;1===a&&(a=5);1===c&&(c=5);a=this._binPack.allocate(b+a,d+c);return 0>=a.width?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new l(this._pageWidth-4,this._pageHeight-4),this._allocateImage(b,
d)):[a,this._currentPage,[this._pageWidth,this._pageHeight]]};e.prototype.dispose=function(){this._binPack=null;this._mosaicRects={};for(var b=0,d=this._textures;b<d.length;b++){var a=d[b];a&&a.dispose()}this._textures.length=0};return e}()});