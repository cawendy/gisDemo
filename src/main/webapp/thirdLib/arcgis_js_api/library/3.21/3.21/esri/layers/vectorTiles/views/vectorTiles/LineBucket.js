// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/vectorTiles/LineBucket","require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper ./Bucket ./LineTess ./style/StyleLayer".split(" "),function(t,u,p,v,q,d,r){return function(n){function f(a,e,c,b){a=n.call(this,a,e)||this;a.extrudeVectorsDoubleBuffer=[d.allocExtrudeVectors(),d.allocExtrudeVectors()];a.firstExtrudeVectors=d.allocExtrudeVectors();a.recycledTriangleBridge=d.allocTriangles(20);a.recycledTrianglePie=d.allocTriangles(20);
a.lineVertexBuffer=c;a.lineIndexBuffer=b;return a}p(f,n);Object.defineProperty(f.prototype,"triangleIndexStart",{get:function(){return this.triangleElementsStart},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"triangleIndexCount",{get:function(){return this.triangleElementsCount},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"connectorStart",{get:function(){return 0},enumerable:!0,configurable:!0});Object.defineProperty(f.prototype,"connectorCount",{get:function(){return 0},
enumerable:!0,configurable:!0});f.prototype.assignBufferInfo=function(a){a.triangleElementsStart=this.triangleElementsStart;a.triangleElementsCount=this.triangleElementsCount};f.prototype.processFeatures=function(a,e){this.triangleElementsStart=this.lineIndexBuffer.index;this.triangleElementsCount=0;a&&a.setExtent(this.layerExtent);for(var c=new r.LineLayout(this.layer,this.zoom),b=0,d=this._features;b<d.length;b++){var h=d[b].getGeometry(a);this._processFeature(c,h)}};f.prototype._processFeature=
function(a,e){if(e){var c=e.length,b;for(b=0;b<c;b++)this._processGeometry(e[b],a)}};f.prototype._processGeometry=function(a,e){if(!(2>a.length)){var c=a[0],b=a[a.length-1],l=b.x-c.x,b=b.y-c.y,c=1E-6>l*l+b*b;if(!(2>a.length)){for(var h=a[0],g=1;g<a.length;)l=a[g].x-h.x,b=a[g].y-h.y,1E-6>l*l+b*b?a.splice(g,1):(h=a[g],++g);if(!(2>a.length)){this.vertices=a;this.verticesLen=a.length;this.isClosed=c;this.cap=e.cap;this.join=e.join;this.almostParallelRads=.05;this.veryShallowRads=.1;this.miterSafeRads=
d.MITER_SAFE_RADS;this.miterLimitMag=Math.min(e.miterLimit,d.SYSTEM_MAG_LIMIT);this.roundLimitRads=Math.min(e.roundLimit,.5);this.newRoundJoinsSafeRads=2.3;for(var l=this.lineIndexBuffer.index,b=0,f=void 0,h=this.verticesLen,g=0;g<h;++g){var m=a[g],k=f===this.extrudeVectorsDoubleBuffer[g%2]?this.extrudeVectorsDoubleBuffer[(g+1)%2]:this.extrudeVectorsDoubleBuffer[g%2];g<h||!c?(this._computeExtrudeVectors(k,g),this._writeGPUVertices(m.x,m.y,b,k),!k.capCenter||c&&g===h-1||this._writeGPUPieElements(k),
c&&0===g&&d.copyExtrudeVectors(this.firstExtrudeVectors,k)):d.copyExtrudeVectors(k,this.firstExtrudeVectors);f&&this._writeGPUBridgeElements(f,k);g<h-1&&(f=a[g+1],m=d.length([f.x-m.x,f.y-m.y]),b+=m);f=k}this.triangleElementsCount+=3*(this.lineIndexBuffer.index-l)}}}};f.prototype._computeExtrudeVectors=function(a,e){var c=this.vertices,b=this.verticesLen,l=this.isClosed,h=c[e],g=[void 0,void 0],f=[void 0,void 0];if(0<e&&e<b-1){var m=c[(e+b-1)%b],k=c[(e+1)%b];d.normalize(g,[h.x-m.x,h.y-m.y]);d.normalize(f,
[k.x-h.x,k.y-h.y])}else if(0===e)k=c[(e+1)%b],d.normalize(f,[k.x-h.x,k.y-h.y]),l?(c=c[b-2],d.normalize(g,[h.x-c.x,h.y-c.y])):g=f;else if(e===b-1)m=c[(e+b-1)%b],d.normalize(g,[h.x-m.x,h.y-m.y]),l?(c=c[1],d.normalize(f,[c.x-h.x,c.y-h.y])):f=g;else{console.error("Vertex index 'i' out of range.");return}l||0!==e?l||e!==b-1?this._computeJoinExtrudeVectors(a,g,f):this._computeCapExtrudeVectors(a,g,f,d.CapPosition.END):this._computeCapExtrudeVectors(a,g,f,d.CapPosition.START)};f.prototype._computeCapExtrudeVectors=
function(a,e,c,b){0===this.cap?d.buttCap(a,e,c):1===this.cap?d.roundCap(a,e,c,b,d.getNumberOfSlices(Math.PI),b===d.CapPosition.START?-1:1):2===this.cap?d.squareCap(a,e,c,b):(d.buttCap(a,e,c),console.error("Unknown cap type!"))};f.prototype._computeJoinExtrudeVectors=function(a,e,c){var b=d.getRads(e,c);if(b>Math.PI-this.almostParallelRads)d.rectJoin(a,e,c);else if(2===this.join||b<this.veryShallowRads)b<this.almostParallelRads?d.fastMiterJoin(a,e,c):b<this.miterSafeRads?d.miterJoin(a,e,c):d.bevelJoin(a,
e,c,this.miterLimitMag);else if(0===this.join)d.bevelJoin(a,e,c,1);else if(1===this.join){var f=d.getNumberOfSlices(b);b<this.newRoundJoinsSafeRads?2>f||b<this.roundLimitRads?d.bevelJoin(a,e,c,1):d.roundJoin(a,e,c,f):d.unitRoundJoin(a,e,c,f)}};f.prototype._writeGPUVertices=function(a,e,c,b){var d;for(d=0;d<b.vectors.count;++d){var f=this.lineVertexBuffer.add(a,e,b.vectors.items[d].vector[0],b.vectors.items[d].vector[1],b.vectors.items[d].texCoords[0],b.vectors.items[d].texCoords[1],c);b.vectors.items[d].base=
f}};f.prototype._writeGPUBridgeElements=function(a,e){d.bridge(this.recycledTriangleBridge,a,e);var c;for(c=0;c<this.recycledTriangleBridge.count;++c){var b=this.recycledTriangleBridge.items[c];this.lineIndexBuffer.add(b.v1.base,b.v2.base,b.v3.base)}};f.prototype._writeGPUPieElements=function(a){d.pie(this.recycledTrianglePie,a);for(a=0;a<this.recycledTrianglePie.count;++a){var e=this.recycledTrianglePie.items[a];this.lineIndexBuffer.add(e.v1.base,e.v2.base,e.v3.base)}};return f}(q)});