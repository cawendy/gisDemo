// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.
//>>built
define("esri/dijit/AppProxySettings","require dojo/_base/array dojo/_base/declare dojo/_base/lang ../kernel dojo/uacss dijit/_WidgetBase ../arcgis/AppProxyManager ../arcgis/utils dojo/i18n!../nls/jsapi dojo/Deferred dojo/on dojo/promise/all dojo/query dojo/string dojo/dom-attr dojo/dom-class dojo/dom-construct dojo/store/Memory dgrid/OnDemandGrid dgrid/Selection dgrid/editor dojo/domReady!".split(" "),function(t,e,n,c,u,v,f,w,x,p,g,m,q,y,r,E,h,z,A,B,C,D){f=n([f],{declaredClass:"esri.dijit.AppProxySettings",
_creditDomains:[/demographics\w*\.arcgis\.com/i,/geoenrich\w*\.arcgis\.com/i,/route\w*\.arcgis\.com/i,/logistics\w*\.arcgis\.com/i,/analysis\w*\.arcgis\.com/i,/elevation\w*\.arcgis\.com/i],_premiumDomains:[/traffic\w*\.arcgis\.com/i,/landsat\w*\.arcgis\.com/i,/elevation\w*\.arcgis\.com/i,/geoenrich\w*\.arcgis\.com/i,/hydro\w*\.arcgis\.com/i,/naip\w*\.arcgis\.com/i,/livefeeds\w*\.arcgis\.com/i,/demographics\w*\.arcgis\.com/i,/landscape\w*\.arcgis\.com/i,/historical\w*\.arcgis\.com/i,/earthobs\w*\.arcgis\.com/i],
defaults:{webmaps:[],proxyManagerOptions:{appid:""},proxies:[]},constructor:function(a){this.css={container:"esriAppProxySettings"};a=c.mixin({},this.defaults,a);this.set(a);this.appProxyManager=new w(this.proxyManagerOptions);if(this.appProxyManager.loaded)this._init();else m.once(this.appProxyManager,"load",c.hitch(this,function(){this._init()}))},startup:function(){this.inherited(arguments);if(this.loaded)this._createTable();else m.once(this,"load",c.hitch(this,function(){this._createTable()}))},
resize:function(){this._grid&&this._grid.resize()},_queryForSecureServices:function(a){return x.getItem(a).then(c.hitch(this,this._parseMap)).then(c.hitch(this,function(a){var b=this._mapsProxies;e.forEach(a,c.hitch(this,function(a){b.push(a)}));return a}))},_loaded:function(){this.set("loaded",!0);this.emit("load")},_itemInApp:function(a,b){return e.some(this._mapsProxies,function(l){if(l[a]===b.url)return l.title=b.title,!0})},_parseUrl:function(a){var b=document.createElement("a");b.href=a;return b},
_consumesCredits:function(a){return e.some(this._creditDomains,function(b){return-1<a.search(b)})},_isPremium:function(a){return e.some(this._premiumDomains,function(b){return-1<a.search(b)})},_checkItem:function(a){var b=new g,l=this._parseUrl(a.url);this._isPremium(l.host)?b.resolve({sourceUrl:a.url,id:a.id,title:a.title,proxyId:null,proxied:!1}):b.resolve();return b.promise},_parseMap:function(a){if(a&&a.itemData){var b=[];e.forEach(a.itemData.operationalLayers,c.hitch(this,function(a){this._itemInApp("sourceUrl",
a)||b.push(this._checkItem(a))}));return q(b).then(function(a){var b=[];e.forEach(a,function(a){a&&b.push(a)});return b})}a=new g;a.resolve();return a.promise},_getWebmapsProxies:function(){this._mapsProxies=this.proxies;for(var a=[],b=0,c=this.webmaps.length;b<c;b++)a.push(this._queryForSecureServices(this.webmaps[b]));return q(a)},_webmapsChanged:function(){var a=new g;this.webmaps&&this.webmaps.length?this._getWebmapsProxies().then(c.hitch(this,function(){this.set("proxies",this._mapsProxies);
a.resolve()})):a.resolve();return a.promise},_init:function(){var a=this.appProxyManager.proxies;e.forEach(a,c.hitch(this,function(a,c){if(!a.hasOwnProperty("title")){var b=this._parseUrl(a.sourceUrl);b&&b.host&&(a.title=r.substitute(p.widgets.appProxySettings.untitled,{url:b.host}))}a.hasOwnProperty("proxied")||(a.proxied=!0,a.id="AppProxy"+c)}));this.proxies=a;this.webmaps&&this.webmaps.length?this._webmapsChanged().then(c.hitch(this,function(){this._loaded()})):this._loaded()},_createTable:function(){this._memoryStore=
new A({data:this.proxies});var a=z.create("div",{className:this.css.container},this.domNode);this._grid=new (n([B,C]))({store:this._memoryStore,selectionMode:"single",columns:{proxied:D({label:"",field:"proxied",editor:"checkbox"}),title:{label:p.widgets.appProxySettings.premiumContent,get:c.hitch(this,function(a){var b=a.title;this._consumesCredits(a.sourceUrl)&&(b+=" ${url}");return b}),formatter:function(a){return r.substitute(a,{url:'\x3cimg width\x3d"16" height\x3d"16" src\x3d"'+t.toUrl("../css/images/item_type_icons/premiumcredits16.png")+
'" /\x3e'})}}}},a);this._grid.startup();this.own(m(this._grid,"dgrid-datachange",c.hitch(this,function(a){var b=a.cell,d,e=y("input",b.element),f=a.target;e&&e.length&&(d=e[0]);d&&h.add(d,"esriAppProxyHidden");h.add(f,"esriAppProxyLoading");var k=b.row.data,g=a.value;g?this.appProxyManager.createProxies([k]).then(c.hitch(this,function(a){this._updateProxy(k,g,a);this.emit("create-proxy",k);h.remove(f,"esriAppProxyLoading");d&&h.remove(d,"esriAppProxyHidden")})):this.appProxyManager.deleteProxies([k]).then(c.hitch(this,
function(){this._updateProxy(k,g);this.emit("delete-proxy",k);h.remove(f,"esriAppProxyLoading");d&&h.remove(d,"esriAppProxyHidden")}))})))},_updateProxy:function(a,b,f){e.some(f,c.hitch(this,function(d){if(d.sourceUrl===a.sourceUrl)return d.proxied=b,this._memoryStore&&(d=c.mixin(a,{proxyId:d.proxyId}),this._memoryStore.put(d,{overwrite:!0})),!0}))},_setWebmapsAttr:function(a){a=a.slice();this._set("webmaps",a);this._created&&this._memoryStore&&this._webmapsChanged()},_setProxiesAttr:function(a){a=
a.slice();this._set("proxies",a);this._created&&this._memoryStore&&(this._memoryStore.setData(this.proxies),this._grid.set("store",this._memoryStore))}});v("extend-esri")&&c.setObject("dijit.AppProxySettings",f,u);return f});