// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.
//>>built
define("esri/arcgis/AppProxyManager","dojo/_base/declare dojo/_base/lang ../kernel dojo/uacss dojo/Deferred dojo/promise/all dojo/json dojo/Evented dojo/Stateful ../request ./utils".split(" "),function(g,f,m,n,h,t,k,p,q,l,r){g=g([p,q],{constructor:function(a){this.defaults={appid:"",hitsPerInterval:0,intervalSeconds:60,referrers:[],proxies:[]};a=f.mixin({},this.defaults,a);this.set(a);this._init()},createProxies:function(a){var b=new h;this._registerApp(this._appItem).then(f.hitch(this,function(){var c=
{referrers:this.referrers},d=this.hitsPerInterval;isNaN(d)||(c.hitsPerInterval=d);d=this.intervalSeconds;isNaN(d)||(c.intervalSeconds=d);for(var d=[],e=0;e<a.length;e++)d.push({sourceUrl:a[e].sourceUrl});e=this._sharingBaseUrl+"content/users/"+this._owner+"/";this._folderId&&(e+=this._folderId+"/");e+="items/"+this.appid+"/createProxies";l({url:e,content:{proxies:k.stringify(d),serviceProxyParams:k.stringify(c),f:"json"},callbackParamName:"callback"},{usePost:!0}).then(f.hitch(this,function(a){this.set("proxies",
a.appProxies||[]);b.resolve(a.appProxies)}),b.reject)}),b.reject);return b.promise},deleteProxies:function(a){var b=new h,c={f:"json"},d=[];if(a&&a.length)for(var e=0;e<a.length;e++)d.push(a[e].proxyId);d&&d.length&&(c.proxies=d.toString());a=this._sharingBaseUrl+"content/users/"+this._owner+"/";this._folderId&&(a+=this._folderId+"/");a+="items/"+this.appid+"/deleteProxies";l({url:a,content:c,callbackParamName:"callback"},{usePost:!0}).then(f.hitch(this,function(a){var c=this.proxies.slice();a=a.results;
if(c&&c.length&&a&&a.length)for(var d=0;d<c.length;d++)for(var e=c[d],f=e.proxyId,g=0;g<a.length;g++){var h=a[g].proxyId;h&&f&&h===f&&(e.proxied=!1)}this.set("proxies",c);b.resolve(c)}),b.reject);return b.promise},_parseUrl:function(a){var b=document.createElement("a");b.href=a;return b},_init:function(){this.appid?r.getItem(this.appid).then(f.hitch(this,function(a){this._appItem=a;this._folderId=a.item.ownerFolder;var b=this._parseUrl(a.item.url);this._sharingBaseUrl="https://"+b.hostname+"/sharing/rest/";
var c=b.pathname.substring(0,b.pathname.lastIndexOf("/")),c="/"===c.charAt(0)?c:"/"+c,b=b.hostname+c,c="https://"+b;this.referrers.push("http://"+b);this.referrers.push(c);this._owner=a.item.owner;-1!==a.item.typeKeywords.indexOf("App Proxy")&&a.item.appProxies&&this.set("proxies",a.item.appProxies);this.emit("load",{});this.set("loaded",!0)})):console.error("AppProxyManager: appid required.")},_registerApp:function(a){var b=new h,c=a.item.id,d=this._sharingBaseUrl+"oauth2/",e=this.referrers;this._registered&&
this._registered===this.appid?b.resolve(a):-1!==a.item.typeKeywords.indexOf("Registered App")?b.resolve(a):l({url:d+"/registerApp",content:{itemId:c,appType:"browser",redirect_uris:k.stringify(e),f:"json"},callbackParamName:"callback"},{usePost:!0}).then(f.hitch(this,function(a){this._registered=this.appid;b.resolve(a)}),b.reject);return b.promise}});n("extend-esri")&&f.setObject("arcgis.AppProxyManager",g,m);return g});