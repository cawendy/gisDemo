// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.
//>>built
require({cache:{"dojo/debounce":function(){define([],function(){return function(r,u){var l;return function(){l&&clearTimeout(l);var f=this,h=arguments;l=setTimeout(function(){r.apply(f,h)},u)}}})},"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(r,u,l,f){var h=function(f,n){return f-n},x={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(f){var n=String(f),k=n.match(x._reNumber);f={integer:0,fractional:0};k&&k[1]?(f.integer=k[1].split("").length,
f.fractional=k[3]?k[3].split("").length:0):-1<n.toLowerCase().indexOf("e")&&(k=n.split("e"),n=k[0],k=k[1],n&&k&&(n=Number(n),k=Number(k),(f=0<k)||(k=Math.abs(k)),n=x.getDigits(n),f?(n.integer+=k,n.fractional=k>n.fractional?0:n.fractional-k):(n.fractional+=k,n.integer=k>n.integer?1:n.integer-k),f=n));return f},getFixedNumbers:function(f,n){var k,l;k=Number(f.toFixed(n));k<f?l=k+1/Math.pow(10,n):(l=k,k-=1/Math.pow(10,n));k=Number(k.toFixed(n));l=Number(l.toFixed(n));return[k,l]},getPctChange:function(f,
n,k,l){var h={prev:null,next:null},w;null!=k&&(w=f-k,h.prev=Math.floor(Math.abs(100*(n-k-w)/w)));null!=l&&(w=l-f,h.next=Math.floor(Math.abs(100*(l-n-w)/w)));return h},round:function(f,l){var k=f.slice(0),n,w,r,u,y,c,v,H,p,t=l&&null!=l.tolerance?l.tolerance:2,F=l&&l.indexes,C=l&&null!=l.strictBounds?l.strictBounds:!1;if(F)F.sort(h);else for(F=[],c=0;c<k.length;c++)F.push(c);for(c=0;c<F.length;c++)if(p=F[c],n=k[p],w=0===p?null:k[p-1],r=p===k.length-1?null:k[p+1],u=x.getDigits(n),u=u.fractional){v=0;
for(H=!1;v<=u&&!H;)y=x.getFixedNumbers(n,v),y=C&&0===c?y[1]:y[0],H=x.hasMinimalChange(n,y,w,r,t),v++;H&&(k[p]=y)}return k},hasMinimalChange:function(f,l,k,h,r){f=x.getPctChange(f,l,k,h);l=null==f.prev||f.prev<=r;k=null==f.next||f.next<=r;return l&&k||f.prev+f.next<=2*r},_reAllZeros:new RegExp("\\"+l.decimal+"0+$","g"),_reSomeZeros:RegExp("(\\d)0*$","g"),format:function(f,l){l=l||{places:20,round:-1};var k=u.format(f,l);k&&(k=k.replace(x._reSomeZeros,"$1").replace(x._reAllZeros,""));return k}};r("extend-esri")&&
(f.numberUtils=x);return x})},"esri/renderers/utils":function(){define("dojo/_base/lang dojo/_base/array dojo/has dojo/date/locale ../kernel ../numberUtils ../Color dojo/i18n!../nls/jsapi dojo/i18n!dojo/cldr/nls/gregorian".split(" "),function(r,u,l,f,h,x,w,n,k){function P(c){return c&&u.map(c,function(c){return new w(c)})}function L(c,f,l){var p="";0===f?p=G.lt+" ":f===l&&(p=G.gt+" ");return p+c}var B={},G={lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e",pct:"%"},y={millisecond:0,second:1,minute:2,
hour:3,day:4,month:5,year:6},c={millisecond:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},
v={formatLength:"short",fullYear:!0},H={formatLength:"short"};r.mixin(B,{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(c,t){var p,l=[];null==c||c instanceof Date||(c=new Date(c));t=t||{};t=r.mixin({},t);var h=t.selector?t.selector.toLowerCase():null;p=!h||-1<h.indexOf("time");h=!h||-1<h.indexOf("date");p&&(t.timeOptions=t.timeOptions||H,t.timeOptions&&(t.timeOptions=r.mixin({},t.timeOptions),t.timeOptions.selector=t.timeOptions.selector||
"time",l.push(t.timeOptions)));h&&(t.dateOptions=t.dateOptions||v,t.dateOptions&&(t.dateOptions=r.mixin({},t.dateOptions),t.dateOptions.selector=t.dateOptions.selector||"date",l.push(t.dateOptions)));l&&l.length?(l=u.map(l,function(p){return f.format(c,p)}),p=1==l.length?l[0]:k["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(c,f){return l[f]})):p=f.format(c);return p},createColorStops:function(c){var f=c.values,p=c.colors,l=c.labelIndexes,k=c.isDate,h=c.dateFormatOptions;
c=[];return c=u.map(f,function(c,t){var C=null;if(!l||-1<u.indexOf(l,t)){var n;(n=k?B.formatDate(c,h):x.format(c))&&(C=L(n,t,f.length-1))}return{value:c,color:p[t],label:C}})},updateColorStops:function(c){var f=c.stops,p=c.changes,l=c.isDate,k=c.dateFormatOptions,h=[],n,r=u.map(f,function(c){return c.value});u.forEach(p,function(c){h.push(c.index);r[c.index]=c.value});n=x.round(r,{indexes:h});u.forEach(f,function(c,p){c.value=r[p];if(null!=c.label){var t,h=null;(t=l?B.formatDate(n[p],k):x.format(n[p]))&&
(h=L(t,p,f.length-1));c.label=h}})},createClassBreakLabel:function(c){var f=c.minValue,p=c.maxValue,l=c.isFirstBreak?"":G.gt+" ";c="percent-of-total"===c.normalizationType?G.pct:"";f=null==f?"":x.format(f);p=null==p?"":x.format(p);return l+f+c+" "+n.smartMapping.minToMax+" "+p+c},setLabelsForClassBreaks:function(c){var f=c.classBreaks,l=c.classificationMethod,p=c.normalizationType,k=[];f&&f.length&&("standard-deviation"===l?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):
c.round?(k.push(f[0].minValue),u.forEach(f,function(c){k.push(c.maxValue)}),k=x.round(k),u.forEach(f,function(c,f){c.label=B.createClassBreakLabel({minValue:0===f?k[0]:k[f],maxValue:k[f+1],isFirstBreak:0===f,normalizationType:p})})):u.forEach(f,function(c,f){c.label=B.createClassBreakLabel({minValue:c.minValue,maxValue:c.maxValue,isFirstBreak:0===f,normalizationType:p})}))},updateClassBreak:function(c){var f=c.classBreaks,l=c.normalizationType,p=c.change,k=p.index,p=p.value,h=-1,n=-1,r=f.length;"standard-deviation"===
c.classificationMethod?console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):(0===k?h=k:k===r?n=k-1:(n=k-1,h=k),-1<h&&h<r&&(c=f[h],c.minValue=p,c.label=B.createClassBreakLabel({minValue:c.minValue,maxValue:c.maxValue,isFirstBreak:0===h,normalizationType:l})),-1<n&&n<r&&(c=f[n],c.maxValue=p,c.label=B.createClassBreakLabel({minValue:c.minValue,maxValue:c.maxValue,isFirstBreak:0===n,normalizationType:l})))},calculateDateFormatInterval:function(c){var f,
l,k=c.length,p,h,n,r,v,w,x=Infinity,B;c=u.map(c,function(c){return new Date(c)});for(f=0;f<k-1;f++){p=c[f];n=[];v=Infinity;w="";for(l=f+1;l<k;l++)h=c[l],h=p.getFullYear()!==h.getFullYear()&&"year"||p.getMonth()!==h.getMonth()&&"month"||p.getDate()!==h.getDate()&&"day"||p.getHours()!==h.getHours()&&"hour"||p.getMinutes()!==h.getMinutes()&&"minute"||p.getSeconds()!==h.getSeconds()&&"second"||"millisecond",r=y[h],r<v&&(v=r,w=h),n.push(h);v<x&&(x=v,B=w)}return B},createUniqueValueLabel:function(f){var l=
f.value,k=f.fieldInfo,h=f.domain;f=f.dateFormatInterval;var p=String(l);(h=h&&h.codedValues?h.getName(l):null)?p=h:"number"===typeof l&&(p=k&&"esriFieldTypeDate"===k.type?B.formatDate(l,f&&c[f]):x.format(l));return p},cloneColorInfo:function(c){var f;c&&(f=r.mixin({},c),f.colors=P(f.colors),f.stops=f.stops&&u.map(f.stops,function(c){c=r.mixin({},c);c.color&&(c.color=new w(c.color));return c}),f.legendOptions&&(f.legendOptions=r.mixin({},f.legendOptions)));return f},cloneOpacityInfo:function(c){var f;
if(c){f=r.mixin({},c);if(c=f.opacityValues)f.opacityValues=c.slice(0);if(c=f.stops)f.stops=u.map(c,function(c){return r.mixin({},c)});if(c=f.legendOptions)f.legendOptions=r.mixin({},c)}return f},cloneSizeInfo:function(c){var f;c&&(f=r.mixin({},c),f.stops&&(f.stops=u.map(f.stops,function(c){return r.mixin({},c)})),(c=f.minSize)&&"object"===typeof c&&(f.minSize=B.cloneSizeInfo(c)),(c=f.maxSize)&&"object"===typeof c&&(f.maxSize=B.cloneSizeInfo(c)),c=f.legendOptions)&&(f.legendOptions=r.mixin({},c),c=
c.customValues)&&(f.legendOptions.customValues=c.slice(0));return f}});l("extend-esri")&&r.setObject("renderer.utils",B,h);return B})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/Deferred dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleLineSymbol ../symbols/jsonUtils ../renderers/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(r,
u,l,f,h,x,w,n,k,P,L,B,G,y,c,v,H,p,t,F,C,T,Q,O,J,E,M,Y,Z,aa,ba,ca,da,R,ea,U,V,N,W,X,S){var I=u([X,p],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,_preserveCacheOnDestroy:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new w([64,64,64]),defaultText:"Aa",sizeRampLightColor:new w([255,255,255]),sizeRampDarkColor:new w([128,128,128]),layerConnects:[],gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",
gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,constructor:function(a,b){l.mixin(this,S.widgets.legend);this._i18n=S.widgets.legend;a=a||{};a.map?b?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?!1:!0,this._respectVisibility=!1===a.respectVisibility?!1:!0,this._preserveCacheOnDestroy=a.preserveCacheOnDestroy?!0:!1,this.arrangement=a.arrangement===I.ALIGN_RIGHT?I.ALIGN_RIGHT:I.ALIGN_LEFT,this.arrangement===I.ALIGN_RIGHT&&
(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?!1:!0,this._surfaceItems=[],this.hideLayersInLegend={},this.refresh=n(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],b,d;for(b=0;b<a.length;b+=1)d=a[b],r.locale&&-1!==r.locale.indexOf(d)&&(-1!==r.locale.indexOf("-")?-1!==r.locale.indexOf(d+
"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},startup:function(){this.inherited(arguments);this._initialize();9>k("ie")&&(this._repaintItems=l.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();
this._removeCachedLegendResponses();this._removeHoverHandlers();this.inherited(arguments)},_removeCachedLegendResponses:function(){this._preserveCacheOnDestroy||f.forEach(this.layers,function(a){delete a.legendResponse})},refresh:function(a){if(this.domNode){a?(this.layerInfos=a,this.layers=[],f.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=
a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this)):this.useAllMapLayers&&(this.layers=this.layerInfos=null);for(a=this.domNode.children.length-1;0<=a;a--)c.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&
(this.layers=[],f.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=
!0;this.layers=[];var a=[],b=[];f.forEach(this.map.layerIds,function(d){d=this.map.getLayer(d);var e;this._isSupportedLayerType(d)&&(d.arcgisProps&&d.arcgisProps.title&&(d._titleForLegend=d.arcgisProps.title),this.layers.push(d));"esri.layers.KMLLayer"==d.declaredClass&&(e=d.getLayers(),f.forEach(e,function(b){a.push(b.id)},this));"esri.layers.GeoRSSLayer"==d.declaredClass&&(e=d.getFeatureLayers(),f.forEach(e,function(a){b.push(a.id)},this))},this);f.forEach(this.map.graphicsLayerIds,function(d){var e=
this.map.getLayer(d);-1==f.indexOf(a,d)&&-1==f.indexOf(b,d)&&this._isSupportedLayerType(e)&&this._isLayerDrawingEnabled(e)&&(e.arcgisProps&&e.arcgisProps.title&&(e._titleForLegend=e.arcgisProps.title),this.layers.push(e))},this)}this._createLegend()},_isLayerDrawingEnabled:function(a){return a&&(a._params&&a._params.drawMode||a.isAggregationEnabled&&a.isAggregationEnabled())},_activate:function(){this._deactivate();this.autoUpdate&&(this._respectCurrentMapScale&&(this._ozeConnect=h.connect(this.map,
"onZoomEnd",this,"_refreshLayers")),this.useAllMapLayers&&(this._olaConnect=h.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers"),this._olrConnect=h.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers"),this._olroConnect=h.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers")),f.forEach(this.layers,function(a){var b={};b.oarcConnect=h.connect(a,"onAggregationRendererChange",this,"_refreshLayers");b.oaicConnect=h.connect(a,"onAggregationInfoChange",this,"_refreshLayers");b.ovcConnect=
h.connect(a,"onVisibilityChange",this,"_refreshLayers");b.oocConnect=h.connect(a,"onOpacityChange",this,"_refreshLayers");b.oscConnect=h.connect(a,"onScaleRangeChange",this,"_refreshLayers");"esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass&&a.supportsDynamicLayers&&(b.odcConnect=h.connect(a,"_onDynamicLayersChange",l.hitch(this,"_updateDynamicLayers",a)));"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&(b.oirConnect=h.connect(a,"onRenderingChange",l.partial(this._updateImageServiceLayers,
this,a)),b.oivrConnect=h.connect(a,"onRendererChange",l.partial(this._updateImageServiceLayers,this,a)));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&(b.oivrConnect=h.connect(a,"onRendererChange",l.hitch(this,"_refreshLayers")));this.layerConnects[a.id]=b},this))},_deactivate:function(){this._ozeConnect&&h.disconnect(this._ozeConnect);this._olaConnect&&h.disconnect(this._olaConnect);this._olroConnect&&h.disconnect(this._olroConnect);this._olrConnect&&h.disconnect(this._olrConnect);
f.forEach(this.layers,function(a){a=this.layerConnects[a.id]||{};a.oarcConnect&&h.disconnect(a.oarcConnect);a.oaicConnect&&h.disconnect(a.oaicConnect);a.ovcConnect&&h.disconnect(a.ovcConnect);a.oocConnect&&h.disconnect(a.oocConnect);a.oscConnect&&h.disconnect(a.oscConnect);a.odcConnect&&h.disconnect(a.odcConnect);a.oirConnect&&h.disconnect(a.oirConnect);a.oivrConnect&&h.disconnect(a.oivrConnect)},this);this.layerConnects=[]},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},
_updateImageServiceLayers:function(a,b){delete b.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];f.forEach(this.map.layerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this.layers.push(a)},this);f.forEach(this.map.graphicsLayerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this._isLayerDrawingEnabled(a)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=
!1,b=!1;v.set(this.domNode,"position","relative");c.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var d=[];f.forEach(this.layers,function(g){if("esri.layers.KMLLayer"==g.declaredClass||"esri.layers.GeoRSSLayer"==g.declaredClass){var e;g.loaded?("esri.layers.KMLLayer"==g.declaredClass?e=g.getLayers():"esri.layers.GeoRSSLayer"==g.declaredClass&&(e=g.getFeatureLayers(),this.hideLayersInLegend[g.id]&&(e=f.filter(e,function(a){return-1==
f.indexOf(this.hideLayersInLegend[g.id],a.id)},this))),f.forEach(e,function(a){"esri.layers.FeatureLayer"==a.declaredClass&&g._titleForLegend&&(a._titleForLegend=g._titleForLegend+" - ","esriGeometryPoint"==a.geometryType?a._titleForLegend+=this.NLS_points:"esriGeometryPolyline"==a.geometryType?a._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==a.geometryType&&(a._titleForLegend+=this.NLS_areas),d.push(a))},this)):h.connect(g,"onLoad",l.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===
g.declaredClass)if(!g.loaded)h.connect(g,"onLoad",l.hitch(this,function(){this.refresh(this.layerInfos)}));else{if((!this._respectVisibility||this._respectVisibility&&g.visible)&&0<g.layerInfos.length&&f.some(g.layerInfos,function(a){return a.legendURL})){var A=!1;f.forEach(g.layerInfos,function(b){if(b.legendURL&&-1<f.indexOf(g.visibleLayers,b.name)){A||(c.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(g._titleForLegend||g.name||g.id)+"\x3c/span\x3e"},this.domNode),A=!0);
var d;b=b.legendURL;if(g.customParameters||g.customLayerParameters){var e=l.clone(g.customParameters||{});l.mixin(e,g.customLayerParameters||{});for(d in e)b+=(-1===b.indexOf("?")?"?":"\x26")+d+"\x3d"+e[d]}c.create("div",{innerHTML:"\x3cimg src\x3d'"+b+"'/\x3e"},this.domNode);a=!0}},this)}}else"esri.layers.WFSLayer"!==g.declaredClass||g.renderer?d.push(g):(e=c.create("div",{id:this.id+"_"+g.id,"class":"esriLegendService"}),c.create("span",{innerHTML:this._getServiceTitle(g),"class":"esriLegendServiceLabel"},
c.create("td",{align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%"},e))))),c.place(e,this.id,"first"),e=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e),e=c.create("tbody",{},e),"esriGeometryComplex"===g.geometryType?(this._buildRow_Renderer(g,g._pointSymbol,null,this.NLS_points,null,e),this._buildRow_Renderer(g,g._lineSymbol,null,this.NLS_lines,null,e),this._buildRow_Renderer(g,g._polygonSymbol,null,this.NLS_areas,null,e)):
"esriGeometryPoint"===g.geometryType?this._buildRow_Renderer(g,g._pointSymbol,null,"",null,e):"esriGeometryPolyline"===g.geometryType?this._buildRow_Renderer(g,g._lineSymbol,null,"",null,e):"esriGeometryPolygon"===g.geometryType&&this._buildRow_Renderer(g,g._polygonSymbol,null,"",null,e),b=!0)},this);var e=[];f.forEach(d,function(a){if(!a.loaded)var b=h.connect(a,"onLoad",this,function(a){h.disconnect(b);b=null;this.refresh()});else if((!this._respectVisibility||this._respectVisibility&&a.visible)&&
(a.layerInfos||a.renderer||"esri.layers.ArcGISImageServiceLayer"==a.declaredClass)){var d=c.create("div",{id:this.id+"_"+a.id,style:{display:"none"},"class":"esriLegendService"});c.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},c.create("td",{align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%"},d)))));c.place(d,this.id,"first");a.legendResponse||a.renderer&&"esri.renderer.StretchRenderer"!==a.renderer.declaredClass?this._createLegendForLayer(a):
this.isHostedTileService(a)?this._getLayerInfos(a).then(l.hitch(this,function(a){this._createLegendForLayer(a)}),l.hitch(this,function(a){e.push(this._legendRequest(a))})):e.push(this._legendRequest(a))}},this);0!==e.length||a||b?(new B(e)).addCallback(l.hitch(this,function(d){a||b?y.byId(this.id+"_msg").innerHTML="":y.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate()})):(y.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate())},_createLegendForLayer:function(a){if(a.legendResponse||
a.renderer||this.isHostedTileService(a)){var b=!1;if(a.legendResponse||this.isHostedTileService(a)){var d=a.dynamicLayerInfos||a.layerInfos;d&&d.length?f.forEach(d,function(d,g){if(!this.hideLayersInLegend[a.id]||-1===f.indexOf(this.hideLayersInLegend[a.id],d.id)){var e=this._buildLegendItems(a,d,g);b=b||e}},this):"esri.layers.ArcGISImageServiceLayer"==a.declaredClass&&(b=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},0))}else a.renderer&&(d=a.url?a.url.substring(a.url.lastIndexOf("/")+
1,a.url.length):"fc_"+a.id,b=this._buildLegendItems(a,{id:d,name:null,subLayerIds:null,parentLayerId:-1},0));b&&(v.set(y.byId(this.id+"_"+a.id),"display","block"),v.set(y.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=a.version?this._legendRequestServer(a):this._legendRequestTools(a);h.connect(a,"onLoad",l.hitch(this,"_legendRequest"))},_legendRequestServer:function(a){var b=a.url,d=b.indexOf("?"),b=-1<d?b.substring(0,d)+"/legend"+b.substring(d):b+"/legend";
(d=a._getToken())&&(b+="?token\x3d"+d);var e=l.hitch(this,"_processLegendResponse"),g={f:"json"};a._params.dynamicLayers&&(g.dynamicLayers=G.stringify(this._createDynamicLayers(a)),"[{}]"===g.dynamicLayers&&(g.dynamicLayers="[]"));a._params.bandIds&&(g.bandIds=a._params.bandIds);a._params.renderingRule?g.renderingRule=a._params.renderingRule:a.rasterFunctionInfos&&0<a.rasterFunctionInfos.length&&f.forEach(a.rasterFunctionInfos,function(a){a&&a.name&&"none"===a.name.toLowerCase()&&(g.renderingRule=
G.stringify({rasterFunction:a.name}))});return O({url:b,content:g,callbackParamName:"callback",load:function(b,d){e(a,b,d)},error:Q.defaults.io.errorHandler})},_legendRequestTools:function(a){var b=a.url.toLowerCase().indexOf("/rest/"),b=a.url.substring(0,b)+a.url.substring(b+5,a.url.length),b=this._legendUrl+"?soapUrl\x3d"+window.escape(b);if(!k("ie")||8<k("ie"))b+="\x26returnbytes\x3dtrue";var d=l.hitch(this,"_processLegendResponse");return O({url:b,content:{f:"json"},callbackParamName:"callback",
load:function(b,g){d(a,b,g)},error:Q.defaults.io.errorHandler})},_processLegendResponse:function(a,b){b&&b.layers?(a.legendResponse=b,y.byId(this.id+"_"+a.id)&&c.empty(y.byId(this.id+"_"+a.id)),c.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},c.create("td",{align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%"},y.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a)):console.log("Legend could not get generated for "+a.url+": "+
x.toJson(b))},_buildLegendItems:function(a,b,d){var e=!1,g=y.byId(this.id+"_"+a.id),q=b.parentLayerId;if(b.subLayerIds)a=c.create("div",{id:this.id+"_"+a.id+"_"+b.id+"_group",style:{display:"none"},"class":-1==q?0<d?"esriLegendGroupLayer":"":this._legendAlign},-1==q?g:y.byId(this.id+"_"+a.id+"_"+q+"_group")),c.create("td",{innerHTML:C.encode(b.name),align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%","class":"esriLegendLayerLabel"},a))));else{if(this._respectVisibility&&
a.visibleLayers)if(d=a.dynamicLayerInfos||a.layerInfos)if(a._params&&a._params.layers){if(-1===f.indexOf(a.visibleLayers,b.id))return e}else{if(d=this._getReallyVisibleLayers(d,a.visibleLayers),-1===f.indexOf(d,b.id))return e}else if(-1===f.indexOf(a.visibleLayers,b.id))return e;g=c.create("div",{id:this.id+"_"+a.id+"_"+b.id,style:{display:"none"},"class":-1<q?this._legendAlign:""},-1==q?g:y.byId(this.id+"_"+a.id+"_"+q+"_group"));c.create("td",{innerHTML:C.encode(b.name)||"",align:this._align},c.create("tr",
{},c.create("tbody",{},c.create("table",{width:"95%","class":"esriLegendLayerLabel"},g))));d=a.dynamicLayerInfos||a.layerInfos;q=!1;d&&d.length&&(q=f.some(d,function(a){return!!a.drawingInfo}));if(a.legendResponse)e=e||this._buildLegendItems_Tools(a,b,g);else if(a.renderer||q)e=e||this._buildLegendItems_Renderer(a,b,g)}return e},_getReallyVisibleLayers:function(a,b){if(!a||!b||!b.length)return[];var d=[],e=[],g;for(g=0;g<a.length;g++)if(a[g].subLayerIds){if(-1===f.indexOf(b,a[g].id)||-1<f.indexOf(e,
a[g].id))e=e.concat(a[g].subLayerIds)}else-1<f.indexOf(b,a[g].id)&&-1===f.indexOf(e,a[g].id)&&d.push(a[g].id);return d},_buildLegendItems_Tools:function(a,b,d){var e=b.parentLayerId,g=this.map.getScale(),q=!1,A=function(a,b){var d,e;for(d=0;d<a.length;d++)if(b.dynamicLayerInfos)for(e=0;e<b.dynamicLayerInfos[e].length;e++){if(b.dynamicLayerInfos[e].mapLayerId==a[d].layerId)return a[d]}else if(b.id==a[d].layerId)return a[d];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(a,
b,g)){var l=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass)){var z=this._getEffectiveScale(a,b);if(z.minScale&&z.minScale<g||z.maxScale&&z.maxScale>g)l=!1}if(l){var g=A(a.legendResponse.layers,b),k=g.legendType,m=g.layerType,h=g.legend;if(h){"esri.layers.ArcGISImageServiceLayer"!==a.declaredClass&&this._sanitizeLegendResponse(a,g,b);d=c.create("table",{cellpadding:0,cellspacing:0,width:"95%",
"class":"esriLegendLayer"},d);var n=c.create("tbody",{},d);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(d,a,b);f.forEach(h,function(d){if(!(10.1<=a.version&&!d.values&&1<h.length)||!a._hideDefaultSymbol&&"\x3call other values\x3e"!==d.label&&(d.label||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.3<=a.version||"Raster Layer"===m))if(d.url&&0===d.url.indexOf("http")||d.imageData&&0<d.imageData.length)q=!0,this._buildRow_Tools(d,n,a,b.id,k)},this)}}}q&&(v.set(y.byId(this.id+
"_"+a.id+"_"+b.id),"display","block"),-1<e&&(v.set(y.byId(this.id+"_"+a.id+"_"+e+"_group"),"display","block"),this._findParentGroup(a.id,a,e)));return q},_getLayerInfos:function(a){var b=new L,d=a.dynamicLayerInfos||a.layerInfos;if(d&&d.length)if(f.some(d,function(a){return!!a.drawingInfo}))b.resolve(a);else{var e=a.url,g=e.indexOf("?"),e=-1==g?e+"/layers":e.substring(0,g)+"/layers"+e.substring(g,e.length);O({url:e,content:{f:"json"},callbackParamName:"callback",load:function(e,g){e.layers?(f.forEach(d,
function(a){var b=f.filter(e.layers,function(b){return a.source?b.id===a.source.mapLayerId:b.id===a.id});b&&b[0]&&b[0].drawingInfo&&(a.drawingInfo=b[0].drawingInfo,a.fields=b[0].fields)}),b.resolve(a)):b.reject(a)},error:function(d){b.reject(a)}})}return b},_sanitizeLegendResponse:function(a,b,d){var e=b.legend;if(10.1<=a.version&&1<e.length&&!b._sanitized){a=l.getObject("layerDefinition.drawingInfo.renderer",!1,d);var g,c;a||(a=l.getObject("drawingInfo.renderer",!1,d));f.some(e,function(a){if(a.values)return!0})&&
f.some(e,function(a,b){a.values||(c=b,g=a);return!!g});a?"uniqueValue"===a.type?g&&(e.splice(c,1),e.push(g)):"classBreaks"===a.type&&(g&&e.splice(c,1),e.reverse(),g&&e.push(g)):g&&(e.splice(c,1),e.push(g));b._sanitized=!0}},_buildRow_Tools:function(a,b,d,e,g){var f=c.create("tr",{},b),A;this.alignRight?(b=c.create("td",{align:this._isRightToLeft?"left":"right"},f),A=c.create("td",{align:this._isRightToLeft?"left":"right",width:35},f)):(A=c.create("td",{width:35,align:"center"},f),b=c.create("td",
{},f));f=a.url;(!k("ie")||9<=k("ie")||9>k("ie")&&"esri.layers.ArcGISImageServiceLayer"===d.declaredClass)&&a.imageData&&0<a.imageData.length?f="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(f=d.url+"/"+e+"/images/"+a.url,(e=d._getToken())&&(f+="?token\x3d"+e));e=c.create("img",{src:f,border:0,style:"opacity:"+d.opacity},A);a=c.create("td",{innerHTML:C.encode(a.label),align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%",dir:"ltr"},b))));g&&"Stretched"===
g&&10.3<=d.version&&"esri.layers.ArcGISImageServiceLayer"===d.declaredClass&&(a.style.verticalAlign="top",a.style.lineHeight="1",e.style.marginBottom="-1px",e.style.display="block",b.style.verticalAlign="top");9>k("ie")&&(e.style.filter="alpha(opacity\x3d"+100*d.opacity+")")},_getVariable:function(a,b,d){var e;a&&(e=(a=a.getVisualVariablesForType(b,d))&&a[0]);return e},_getVariables:function(a,b,d){a=[this._getVariable(a,"colorInfo",!1),this._getVariable(a,"opacityInfo",!1),this._getVariable(a,"sizeInfo",
!1)];return b?f.filter(a,function(a){return!(!a||a.field!==b||a.normalizationField!=d)}):a},_getFieldAlias:function(a,b,d){var e=b.infoTemplate||(b.infoTemplates&&d&&b.infoTemplates[d.id]?b.infoTemplates[d.id].infoTemplate:null),e=e&&e.getFieldInfo&&e.getFieldInfo(a);a=l.isFunction(a)?null:this.getField(b,a,d);b=e||a;d="";b&&(d=e&&e.label||a&&a.alias||b.name||b.fieldName);return d},_getRampTitle:function(a,b,d){var e,g=a.field,c=a.normalizationField,f=!1,k=!1,z=!1,g=l.isFunction(g)?null:g,c=l.isFunction(c)?
null:c;if(a.legendOptions&&a.legendOptions.title)e=a.legendOptions.title;else if(a.valueExpressionTitle)e=a.valueExpressionTitle;else{if(b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables){var h=b.renderer.authoringInfo.visualVariables;for(a=0;a<h.length;a++){var m=h[a];if("colorInfo"===m.type&&"ratio"===m.style){f=!0;break}else if("colorInfo"===m.type&&"percent"===m.style){k=!0;break}else if("colorInfo"===m.type&&"percentTotal"===m.style){z=!0;break}}}(f=z&&"showRatioPercentTotal"||
k&&"showRatioPercent"||f&&"showRatio"||c&&"showNormField"||g&&"showField"||null)&&(e=J.substitute({field:g&&this._getFieldAlias(g,b,d),normField:c&&this._getFieldAlias(c,b,d)},this._i18n[f]))}return e},_getRendererTitle:function(a,b,d){var e;if(a){var g,c,f;"esri.renderer.ClassBreaksRenderer"===a.declaredClass&&(g=a.attributeField,c=a.normalizationField,f="percent-of-total"===a.normalizationType);g=l.isFunction(g)?null:g;c=l.isFunction(c)?null:c;a.legendOptions&&a.legendOptions.title?e=a.legendOptions.title:
a.valueExpressionTitle?e=a.valueExpressionTitle:(a=c&&"showNormField"||(f?"showNormPct":null)||g&&"showField"||null)&&(e=J.substitute({field:g&&this._getFieldAlias(g,b,d),normField:c&&this._getFieldAlias(c,b,d)},this._i18n[a]))}return e},_buildLegendItems_Renderer:function(a,b,d){var e=b.parentLayerId,g=this.map,q=g.getScale(),A,k=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,b,q)){var z,h,m,n,p,r,t,w;m="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?a.renderer.renderer:
b&&b.drawingInfo?W.fromJson(l.clone(b.drawingInfo.renderer)):a.isAggregationEnabled&&a.isAggregationEnabled()?a.getAggregationRenderer():a.renderer;if("esri.renderer.ScaleDependentRenderer"===m.declaredClass&&(m=(m="zoom"===m.rangeType?m.getRendererInfoByZoom(g.getZoom()):m.getRendererInfoByScale(q))&&m.renderer,!m))return!1;var D=this._getVariables(m),u=f.filter(D,function(a){return!!a}).length,q=D[0],g=D[1],D=D[2],x,B,K,E,F;q&&(n=this._getMedianColor(m,q),q.field&&(r=l.isFunction(q.field)?null:
this.getField(a,q.field,b)),x=!(q.legendOptions&&!1===q.legendOptions.showLegend));g&&(g.field&&(w=l.isFunction(g.field)?null:this.getField(a,g.field,b)),B=!(g.legendOptions&&!1===g.legendOptions.showLegend));D&&(D.field&&(t=l.isFunction(D.field)?null:this.getField(a,D.field,b)),K=!(D.legendOptions&&!1===D.legendOptions.showLegend));if("esri.renderer.HeatmapRenderer"===m.declaredClass)A=k=!0,this._showHeatRamp(a,b,m,d);else if("esri.renderer.DotDensityRenderer"===m.declaredClass)A=k=!0,this._showDotDensityLegend(a,
b,m,d);else if("esri.renderer.TemporalRenderer"===m.declaredClass)A=k=!0,h=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),z=c.create("tbody",{},h),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(h,a,b),m.latestObservationRenderer&&"esri.renderer.SimpleRenderer"===m.latestObservationRenderer.declaredClass&&this._buildRow_Renderer(a,m.latestObservationRenderer.symbol,n,C.encode(m.latestObservationRenderer.label)||this.NLS_currentObservations,null,z),
m.observationRenderer&&"esri.renderer.SimpleRenderer"===m.observationRenderer.declaredClass&&this._buildRow_Renderer(a,m.observationRenderer.symbol,n,C.encode(m.observationRenderer.label)||this.NLS_previousObservations,null,z);else if("esri.renderer.UniqueValueRenderer"===m.declaredClass){if(m.infos&&0<m.infos.length){A=k=!0;if(m.legendOptions&&m.legendOptions.title||m.valueExpressionTitle)h=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),z=c.create("tbody",
{},h),u=m.legendOptions&&m.legendOptions.title?m.legendOptions.title:m.valueExpressionTitle,this._buildRow_Renderer(a,null,n,C.encode(u),null,z);h=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d);z=c.create("tbody",{},h);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(h,a,b);m.attributeField&&D&&this._addSubHeader(z,this._getFieldAlias(m.attributeField,a,b));var G=[];f.forEach(m.infos,function(b){var d=null;a._editable&&a.types&&(d=this._getTemplateFromTypes(a.types,
b.value));var e=b.label;null==e&&(e=b.value);-1===f.indexOf(G,e)&&(G.push(e),this._buildRow_Renderer(a,b.symbol,n,C.encode(e),d,z))},this)}F=this._displayDefaultSymbol(a,m,d)}else if("esri.renderer.ClassBreaksRenderer"===m.declaredClass){if(m.infos&&0<m.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass)A=k=!0,E=this._isUnclassedRenderer(m),q||1!==m.infos.length||(p=(p=m.infos[0])&&p.symbol),E||(h=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
d),z=c.create("tbody",{},h),u=this._getRendererTitle(m,a,b),this._buildRow_Renderer(a,null,n,C.encode(u),null,z)),h=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),z=c.create("tbody",{},h),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(h,a,b),E&&D&&K||(u=m.infos.slice(0).reverse(),f.forEach(u,function(b){var d=b.label;null!=d||E||(d=b.minValue+" - "+b.maxValue);this._buildRow_Renderer(a,b.symbol,n,C.encode(d),null,z)},this)),"esri.layers.ArcGISImageServiceVectorLayer"!==
a.declaredClass||a.renderer.style!==R.STYLE_SCALAR&&a.renderer.style!==R.STYLE_SINGLE_ARROW||(this._buildRow_Renderer(a,m.defaultSymbol,null,"",null,z),a._hideDefaultSymbol=!0);E||(F=this._displayDefaultSymbol(a,m,d))}else"esri.renderer.SimpleRenderer"===m.declaredClass&&(A=k=!0,h=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),z=c.create("tbody",{},h),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(h,a,b),p=null,a._editable&&a.templates&&0<a.templates.length&&
(p=a.templates[0]),h=1<u?null:r&&x||w&&B||t&&K,this._buildRow_Renderer(a,m.symbol,n,C.encode(h?this._getRampTitle(1<u?null:q||g||D,a,b):m.label),p,z),p=q?null:m.symbol,h&&(r=w=t=null));A&&(q&&x&&(q.field||q.valueExpression)&&this._showGradientRamp(a,b,m,null,d,q,r,null,D&&K?!0:!1),D&&K&&(D.field||D.valueExpression)&&(A=q&&x||"esri.renderer.UniqueValueRenderer"===m.declaredClass?!1:!0,this._showSizeLegend(a,b,m,D,n,d,t,null,A)),g&&B&&(g.field||g.valueExpression)&&this._showGradientRamp(a,b,m,p&&!p.url&&
p.color?p.color:this.transparencyRampColor,d,g,w,null,!1));F||E&&!x&&!K&&!B||(F=this._displayDefaultSymbol(a,m,d));k=k||F}k&&(v.set(y.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<e&&(v.set(y.byId(this.id+"_"+a.id+"_"+e+"_group"),"display","block"),this._findParentGroup(a.id,e)));return k},_isUnclassedRenderer:function(a,b){var d;if("esri.renderer.ClassBreaksRenderer"===a.declaredClass&&a.infos&&1===a.infos.length){d=a.attributeField;var e=a.normalizationField;d=b?d===b:!!this._getVariables(a,
d,e).length}return d},_displayDefaultSymbol:function(a,b,d){var e;!a._hideDefaultSymbol&&b.defaultSymbol&&(e=!0,d=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d),d=c.create("tbody",{},d),this._buildRow_Renderer(a,b.defaultSymbol,null,C.encode(b.defaultLabel)||"others",null,d));return e},_showGradientRamp:function(a,b,d,e,g,f,A,h,k){k=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(k?"":" esriLegendSubFragment")},g);g=c.create("tbody",
{},k);(a._hoverLabel||a._hoverLabels||h)&&this._createHoverAction(k,a,b,h);(A||f.valueExpression||f.legendOptions&&f.legendOptions.title)&&this._addSubHeader(g,this._getRampTitle(f,a,b));A=f.field;var q;A&&(q=l.isFunction(A)?null:this.getField(a,A,b));(b=this._getRampStops(d,f,e,q&&"esriFieldTypeDate"===q.type))&&b.length&&this._drawGradientRamp(g,b,!0,a,this._getRampBorderColor(d),!!e)},_getMedianColor:function(a,b){var d,e;b.colors?(d=b.minDataValue,e=b.maxDataValue):b.stops&&(d=b.stops[0].value,
e=b.stops[b.stops.length-1].value);return a.getColor(d+(e-d)/2,{colorInfo:b})},_getRampStops:function(a,b,d,e){var g,c,h,k,l=!1;b.colors||b.opacityValues?(c=b.maxDataValue-b.minDataValue,g=f.map([0,.25,.5,.75,1],function(a){h=b.minDataValue+a*c;return Number(h.toFixed(6))}),this._checkPrecision(0,4,g)):b.stops&&(g=f.map(b.stops,function(a){return a.value}),(l=f.some(b.stops,function(a){return!!a.label}))&&(k=f.map(b.stops,function(a){return a.label})));var n=g[0],m,p;c=g[g.length-1]-n;return f.map(g,
function(f,h){d?(m=new w(d.toRgba()),p=a.getOpacity(f,{opacityInfo:b}),null!=p&&(m.a=p)):m=a.getColor(f,{colorInfo:b});var q="";if(l)q=k[h];else{var q=e?M.formatDate(f,M.timelineDateFormatOptions):E.format(f),A="";0===h?A=this._specialChars.lt+" ":h===g.length-1&&(A=this._specialChars.gt+" ");q=A+q}return{value:f,color:m,offset:1-(f-n)/c,label:q}},this).reverse()},_checkPrecision:function(a,b,d){var e=a+(b-a)/2,g=d[a],c=d[e],f=d[b],h=Math.floor(g),k=Math.floor(c),l=Math.floor(f);h===g&&l===f&&k!==
c&&h!==k&&l!==k&&(d[e]=k);a+1!==e&&this._checkPrecision(a,e,d);e+1!==b&&this._checkPrecision(e,b,d)},_getRampBorderColor:function(a){var b;if("esri.renderer.SimpleRenderer"===a.declaredClass)b=a.symbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)b=a.infos[0].symbol;return(a=b&&-1===b.type.indexOf("linesymbol")?b.getStroke():null)&&a.color},_drawGradientRamp:function(a,b,d,e,g,h){var l=c.create("tr",{},a),q,z,n,m,p,r=b.length-
1,u;m=0;this.alignRight?(a=c.create("td",{align:this._isRightToLeft?"left":"right"},l),q=c.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},l)):(q=c.create("td",{width:this.gradientWidth,align:"center"},l),a=c.create("td",{},l));l=g&&0<g.a&&!(240<=g.r&&240<=g.g&&240<=g.b);z=c.create("div",{"class":l?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},q);q=c.create("div",{"class":"esriLegendColorRamp"+(h?" esriLegendTransparencyRamp":
"")},z);h=v.get(q,"width");l&&(g=9>k("ie")?g.toHex():"rgba("+g.toRgba().join(",")+")",v.set(q,"border",this.colorRampBorder+" "+g));d?(g=this.gradientHeight*r,v.set(q,"height",g+"px")):g=v.get(q,"height");v.set(z,"height",g+"px");l=t.createSurface(q,h,g);9>k("ie")&&(m=l.getEventSource(),v.set(m,"position","relative"),v.set(m.parentNode,"position","relative"),m=1);try{d&&f.forEach(b,function(a,b){a.offset=b/r}),p=l.createRect({x:-m,y:-m,width:h+m,height:g+m}),p.setFill({type:"linear",x1:0,y1:0,x2:0,
y2:g,colors:b}).setStroke(null),l.createRect({width:h,height:g}).setFill(new w([255,255,255,1-e.opacity])).setStroke(null),this._surfaceItems.push(l)}catch(fa){l.clear(),l.destroy()}f.forEach(b,function(a,d){if(a.label){u="top:"+100*a.offset+"%;";var e="";0===d&&(e+=" esriLegendColorRampTickFirst");d===b.length-1&&(e+=" esriLegendColorRampTickLast");c.create("div",{"class":"esriLegendColorRampTick"+e,innerHTML:"\x26nbsp;",style:u},z)}});n=c.create("div",{"class":"esriLegendColorRampLabels",style:{height:g+
this.gradientHeight+"px"}},a);d?f.forEach(b,function(a){c.create("div",{"class":"esriLegendColorRampLabel",innerHTML:C.encode(a.label)||"\x26nbsp;"},n)}):(c.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.high},n),c.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.low,style:"top: "+(g+this.gradientHeight-2*this.gradientHeight)+"px;"},n))},_showHeatRamp:function(a,b,d,e,g){var f,h=d.field;f=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
e);e=c.create("tbody",{},f);(a._hoverLabel||a._hoverLabels||g)&&this._createHoverAction(f,a,b,g);(h=h&&this.getField(a,h,b))&&this._addSubHeader(e,this._getFieldAlias(h.name,a,b));b=this._getHeatmapStops(d);b.length&&this._drawGradientRamp(e,b,!1,a)},_getHeatmapStops:function(a){var b=a.colorStops;a=a.colors;var d,e,g,c;b&&b[0]?(d=b.length-1,(a=b[0]&&null!=b[0].ratio)?(a=b[d])&&1!==a.ratio&&(b=b.slice(0),b.push({ratio:1,color:a.color}),d++):(e=b[0].value,g=b[d].value-e,b=f.map(b,function(a){return{color:a.color,
ratio:(a.value-e)/g}}))):a&&a[0]&&(d=a.length-1,c=1/(a.length-1),b=f.map(a,function(a,b){return{color:a,ratio:b*c}}));b=f.map(b,function(a,b){var e="";0===b?e="Low":b===d&&(e="High");return{color:a.color,label:e,offset:1-a.ratio}});return b.reverse()},_showDotDensityLegend:function(a,b,d,e){var g=d.legendOptions,h,k,n,z,p,m,r,t=this.dotDensitySwatchSize,u=Math.round(t/2);g&&(k=g.backgroundColor,n=g.outline,z=g.valueUnit,p=g.dotCoverage);p=(p||this.dotCoverage)/100;r=Math.round(t*t/Math.pow(d.dotSize,
2)*p);e=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);m=c.create("tbody",{},e);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(e,a,b);this._addSubHeader(m,J.substitute({value:d.dotValue,unit:z||""},this.NLS_dotValue));f.forEach(d.fields,function(e){e=l.mixin({},e);e.numPoints=r;h=new U(d._generateImageSrc(t,t,[e],{x:0,y:0},{x:t,y:t},k),n||d.outline,t,t);e=this.getField(a,e.name,b)||e;this._buildRow_Renderer(a,h,null,C.encode(this._getFieldAlias(e.name,
a,b)),null,m,{type:"path",path:"M "+-u+","+-u+" L "+u+","+-u+" L "+u+","+u+" L "+-u+","+u+" L "+-u+","+-u+" E"})},this)},_showSizeLegend:function(a,b,d,e,g,f,h,k,n){var q=e.legendOptions,q=q&&q.customValues;g=this._getSizeSymbol(d,g);if((!e.valueUnit||"unknown"===e.valueUnit)&&g&&(q||null!=e.minSize&&null!=e.maxSize&&null!=e.minDataValue&&null!=e.maxDataValue||e.stops&&!(1>=e.stops.length))){n=c.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(n?"":" esriLegendSubFragment")},
f);f=c.create("tbody",{},n);(a._hoverLabel||a._hoverLabels||k)&&this._createHoverAction(n,a,b,k);(h||e.valueExpression||e.legendOptions&&e.legendOptions.title)&&this._addSubHeader(f,this._getRampTitle(e,a,b));h=e.field;var m;h&&(m=l.isFunction(h)?null:this.getField(a,h,b));b=m&&"esriFieldTypeDate"===m.type;q=q||this._getDataValues(d,g,e,b);for(m=n=q.length-1;0<=m;m--)h=q[m],g=N.fromJson(g.toJson()),this._applySize(g,d,e,h),h=b?M.formatDate(h,M.timelineDateFormatOptions):E.format(h),k="",m===n?k=this._specialChars.gt+
" ":0===m&&(k=this._specialChars.lt+" "),k="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+C.encode(k+h)+"\x3c/span\x3e",this._buildRow_Renderer(a,g,null,k,null,f)}},_getSizeSymbol:function(a,b){var d,e;if("esri.renderer.SimpleRenderer"===a.declaredClass)d=a.symbol;else if("esri.renderer.VectorFieldRenderer"===a.declaredClass)d=a.defaultSymbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)d=a.infos[0].symbol,e=1<a.infos.length;
if(d=d&&-1!==d.type.indexOf("fillsymbol")?null:d)if(d=N.fromJson(d.toJson()),b||e)-1!==d.type.indexOf("linesymbol")?d.setColor(new w(this.sizeRampDarkColor)):(d.setColor(new w(this.sizeRampLightColor)),d.setOutline&&(e=new V,e.setColor(new w(this.sizeRampDarkColor)),e.setWidth(1.5),d.setOutline(e)));return d},_getDataValues:function(a,b,d,e,c,h){c=null==c?5:c;h=null==h?20:h;var g=a.getSizeRangeAtScale(d,this.map.getScale());c=this._interpolateSizeRange(g,c);var l=this._getDataRange(d),k=f.map(c,function(a){return this._getDataValueFromSize(a,
l,g)},this);if(!e){var q,k=E.round(k);for(e=1;e<k.length-1;e++)if(q=this._roundDataValue(a,b,d,k[e],k[e-1],h))k[e]=q[0],c[e]=q[1]}return k},_getDataRange:function(a){var b=a.stops;return b?{min:b[0].value,max:b[b.length-1].value}:{min:a.minDataValue,max:a.maxDataValue}},_interpolateSizeRange:function(a,b){var d=a.minSize,e=(a.maxSize-d)/(b-1),c,f=[];for(c=0;c<b;c++)f.push(d+e*c);return f},_getDataValueFromSize:function(a,b,d){var e=d.minSize;d=d.maxSize;var c=b.min;b=b.max;return a<=e?c:a>=d?b:(a-
e)/(d-e)*(b-c)+c},_roundDataValue:function(a,b,d,e,c,f){var g=this._getSize(b,a,d,e);c=this._getSize(b,a,d,c);var h,k=E.getDigits(e),l=k.integer,k=k.fractional,m,q,n,p,r,t,u,v,w,x,y;0<e&&1>e&&(h=Math.pow(10,k),e*=h,l=E.getDigits(e).integer);for(--l;0<=l&&(m=Math.pow(10,l),k=Math.floor(e/m)*m,m*=Math.ceil(e/m),null!=h&&(k/=h,m/=h),q=(k+m)/2,q=E.round([k,q,m],{indexes:[1]})[1],n=this._getSize(b,a,d,k),p=this._getSize(b,a,d,m),r=this._getSize(b,a,d,q),t=E.getPctChange(g,n,c,null),u=E.getPctChange(g,
p,c,null),v=E.getPctChange(g,r,c,null),w=t.prev<=f,x=u.prev<=f,w&&x&&(t.prev<=u.prev?(w=!0,x=!1):(x=!0,w=!1)),w?y=[k,n]:x?y=[m,p]:v.prev<=f&&(y=[q,r]),!y);l--);return y},_applySize:function(a,b,d,e){var c=a.type;b=this._getSize(a,b,d,e);switch(c){case "simplemarkersymbol":a.setSize(b);break;case "picturemarkersymbol":c=a.width;d=a.height;a.setHeight(b);a.setWidth(c/d*b);break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(b);break;case "textsymbol":a.font&&a.font.setSize(b)}},_getSize:function(a,
b,d,c){return b.getSize(c,{sizeInfo:d,scale:this.map.getScale(),shape:-1!==a.type.indexOf("markersymbol")?a.style:null})},_buildRow_Renderer:function(a,b,d,e,g,f,h){var k=c.create("tr",{},f),l;this.alignRight?(f=c.create("td",{align:this._isRightToLeft?"left":"right"},k),b&&(l=c.create("td",{align:this._isRightToLeft?"left":"right",width:35},k))):(b&&(l=c.create("td",{width:35,align:"center"},k)),f=c.create("td",{},k));var q=k=30,m;if(b){if("simplemarkersymbol"==b.type)k=Math.min(Math.max(k,b.size+
12),125),q=Math.min(Math.max(q,b.size+12),125);else if("picturemarkersymbol"==b.type)k=Math.min(Math.max(k,b.width),125),q=Math.min(b.height||q,125);else if("textsymbol"==b.type){var n,p;b.text||(n=b.text,p=!0,b.setText(this.defaultText));k=Math.min(Math.max(k,b.getWidth()+12),125);q=Math.min(Math.max(q,b.getHeight()+12),125);p&&b.setText(n)}m=c.create("div",{style:"width:"+k+"px;height:"+q+"px;"},l)}J.isDefined(e)&&"number"===typeof e&&(e=""+e);c.create("td",{innerHTML:e||"",align:this._align},c.create("tr",
{},c.create("tbody",{},c.create("table",{width:"95%"},f))));b&&(a=this._drawSymbol(m,b,d,k,q,g,a,h),this._surfaceItems.push(a))},_addSubHeader:function(a,b){var d=c.create("tr",{},a),d=c.create("td",{align:this._align,colspan:2},d);c.create("td",{innerHTML:C.encode(b)||"",align:this._align},c.create("tr",{},c.create("tbody",{},c.create("table",{width:"95%"},d))))},_drawSymbol:function(a,b,d,c,g,f,h,n){b=N.fromJson(b.toJson());var e=h.opacity;d&&b.setColor(new w(d.toRgba()));if("simplelinesymbol"===
b.type||"cartographiclinesymbol"===b.type||"textsymbol"===b.type){if(!b.color)return;d=b.color.toRgba();d[3]*=e;b.color.setColor(d)}else"simplemarkersymbol"===b.type||"simplefillsymbol"===b.type?(b.color&&(d=b.color.toRgba(),d[3]*=e,b.color.setColor(d)),b.outline&&b.outline.color&&(d=b.outline.color.toRgba(),d[3]*=e,b.outline.color.setColor(d))):"picturemarkersymbol"===b.type&&(a.style.opacity=e,a.style.filter="alpha(opacity\x3d("+100*e+"))");a=t.createSurface(a,c,g);9>k("ie")&&(d=a.getEventSource(),
v.set(d,"position","relative"),v.set(d.parentNode,"position","relative"));f=this._getDrawingToolShape(b,f)||N.getShapeDescriptors(b);var q,e=(d=f.defaultShape)&&"text"===d.type;try{e&&!d.text&&(d.text=this.defaultText),q=a.createShape(n||d).setFill(f.fill).setStroke(f.stroke),e&&q.setFont(f.font)}catch(ga){a.clear();a.destroy();return}var m=q.getBoundingBox();n=m.width;f=m.height;var e=-(m.x+n/2),p=-(m.y+f/2);d=a.getDimensions();e={dx:e+d.width/2,dy:p+d.height/2};if("simplemarkersymbol"===b.type&&
"path"===b.style)c=h._getScaleMatrix(m,b.size),q.applyTransform(F.scaleAt(c.xx,c.yy,{x:d.width/2,y:d.height/2}));else if(n>c||f>g)h=n/c>f/g,c=((h?c:g)-5)/(h?n:f),l.mixin(e,{xx:c,yy:c});q.applyTransform(e);return a},_getDrawingToolShape:function(a,b){var d;switch(b?b.drawingTool||null:null){case "esriFeatureEditToolArrow":d={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 Z"};break;case "esriFeatureEditToolTriangle":d={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 Z"};
break;case "esriFeatureEditToolRectangle":d={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"};break;case "esriFeatureEditToolCircle":d={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":d={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:d,fill:a.getFill(),stroke:a.getStroke()}},_repaintItems:function(){f.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());
try{a.getFill&&a.setFill&&a.setFill(a.getFill())}catch(b){}a.children&&l.isArray(a.children)&&f.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,b,d,e){if(e=b._hoverLabel||b._hoverLabels&&b._hoverLabels[d.id]||e)e=C.encode(e),b.mouseMoveHandler=b.mouseMoveHandler||{},b.mouseMoveHandler[d.id]=h.connect(a,"onmousemove",l.hitch(this,function(a,b){this.mouseX=b.clientX;this.mouseY=b.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,v.set(y.byId(this.id+"_hoverLabel"),"display",
"none"));setTimeout(l.hitch(this,function(a,b,d){if(a==this.mouseX&&b==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,y.byId(this.id+"_hoverLabel")){var e=y.byId(this.id+"_hoverLabel");e.innerHTML="\x3cspan\x3e"+d+"\x3c/span\x3e";v.set(e,"top",b+"px");v.set(e,"left",a+15+"px");v.set(e,"display","")}else c.create("div",{innerHTML:"\x3cspan\x3e"+d+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:b+"px",left:a+15+"px"}},document.body)},b.clientX,b.clientY,
a),500)},e)),b.mouseOutHandler=b.mouseOutHandler||{},b.mouseOutHandler[d.id]=h.connect(a,"onmouseout",l.hitch(this,function(a){this.mouseY=this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,v.set(y.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var a;f.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)h.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)h.disconnect(b.mouseOutHandler[a])})},
_createDynamicLayers:function(a){var b=[],d;f.forEach(a.dynamicLayerInfos||a.layerInfos,function(c){d={id:c.id};d.source=c.source&&c.source.toJson();var e;a.layerDefinitions&&a.layerDefinitions[c.id]&&(e=a.layerDefinitions[c.id]);e&&(d.definitionExpression=e);var f;a.layerDrawingOptions&&a.layerDrawingOptions[c.id]&&(f=a.layerDrawingOptions[c.id]);f&&(d.drawingInfo=f.toJson());d.minScale=c.minScale||0;d.maxScale=c.maxScale||0;b.push(d)});return b},_getTemplateFromTypes:function(a,b){var d;for(d=0;d<
a.length;d++)if(a[d].id==b&&a[d].templates&&0<a[d].templates.length)return a[d].templates[0];return null},_findParentGroup:function(a,b,d){var c,f=b.dynamicLayerInfos||b.layerInfos;for(c=0;c<f.length;c++)if(d==f[c].id){-1<f[c].parentLayerId&&(v.set(y.byId(this.id+"_"+a+"_"+f[c].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,f[c].parentLayerId));break}},_addSubLayersToHide:function(a){function b(d,c){var e=a.layer.dynamicLayerInfos||a.layer.layerInfos,h,k;for(h=0;h<e.length;h++)if(e[h].id===
d&&e[h].subLayerIds)for(k=0;k<e[h].subLayerIds.length;k++){var l=e[h].subLayerIds[k];-1===f.indexOf(c,l)&&(c.push(l),b(l,c))}}a.layer.layerInfos&&f.forEach(this.hideLayersInLegend[a.layer.id],function(d){b(d,this.hideLayersInLegend[a.layer.id])},this)},_isLayerInScale:function(a,b,d){var c,f=!0;if(a.legendResponse&&a.legendResponse.layers)for(c=0;c<a.legendResponse.layers.length;c++){var h=a.legendResponse.layers[c];if(b.id==h.layerId){var k,l;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?
(0==h.minScale&&a.tileInfo&&(k=a.tileInfo.lods[0].scale),0==h.maxScale&&a.tileInfo&&(l=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(k=Math.min(a.minScale,h.minScale)||a.minScale||h.minScale,l=Math.max(a.maxScale,h.maxScale));if(0<k&&k<d||l>d)f=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<d||a.maxScale&&a.maxScale>d)f=!1;return f},_getServiceTitle:function(a){var b=a._titleForLegend;b||(b=a.url,a.url?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),
b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+
a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],J.isDefined(a)&&(b+=" ("+a+")"));return C.encode(b)},_getEffectiveScale:function(a,b){var c=b.minScale,e=b.maxScale;if(J.isDefined(b.parentLayerId)){var f=a.layerInfos,h=b.parentLayerId,k;for(k=f.length-1;0<=k;k--)if(f[k].id==h)if(0==c&&0<f[k].minScale?c=f[k].minScale:0<c&&0==f[k].minScale||0<c&&0<f[k].minScale&&(c=Math.min(c,f[k].minScale)),e=Math.max(e||0,f[k].maxScale||0),-1<f[k].parentLayerId)h=f[k].parentLayerId;
else break}return{minScale:c,maxScale:e}},_isSupportedLayerType:function(a){return a&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.2<=a.version||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===
a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass)?!0:!1},isHostedTileService:function(a){var b=/(https?:)?\/\/services.*\.arcgis\.com/i;return"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass&&b.test(a.url)?!0:!1},getField:function(a,b,c){if(a.getField)return a.getField(b);if(c&&c.fields){var d;f.forEach(c.fields,function(a){a.name===b&&(d=a)});return d}return null}});l.mixin(I,{ALIGN_LEFT:0,ALIGN_RIGHT:1});
k("extend-esri")&&l.setObject("dijit.Legend",I,T);return I});