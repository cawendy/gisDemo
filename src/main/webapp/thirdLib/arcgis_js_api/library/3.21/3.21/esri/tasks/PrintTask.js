// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.
//>>built
define("esri/tasks/PrintTask","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/has ../kernel ../lang ../layerUtils ../deferredUtils ../Color ../urlUtils ./Task ../geometry/Polygon ../renderers/SimpleRenderer ../symbols/FillSymbol ./Geoprocessor ./PrintTemplate dojo/dom-attr dojo/dom-construct dojox/gfx/_base dojox/gfx/canvas dojox/json/query dojo/has!extend-esri?./PrintParameters dojo/has!extend-esri?./LegendLayer".split(" "),function(w,m,q,A,D,B,E,y,C,
F,G,H,I,J,K,L,M,N,O,P,u,z,Q){w=w(I,{declaredClass:"esri.tasks.PrintTask",constructor:function(a,e){this.url=a;this.printGp=new M(this.url);this._handler=m.hitch(this,this._handler);e&&e.async&&(this.async=e.async);this._colorEvaluator=Q("$..color")},_vtlExtent:null,_handler:function(a,e,h,b,d){try{var c;this.async?"esriJobSucceeded"===a.jobStatus&&this.printGp.getResultData(a.jobId,"Output_File",m.hitch(this,function(b){c=b.value;this._successHandler([c],"onComplete",h,d)})):(c=a[0].value,this._successHandler([c],
"onComplete",h,d))}catch(k){this._errorHandler(k,b,d)}},execute:function(a,e,h){var b=this._handler,d=this._errorHandler,c=a.template||new N;c.hasOwnProperty("showLabels")||(c.showLabels=!0);var k=c.exportOptions,f;k&&(f={outputSize:[k.width,k.height],dpi:k.dpi});var k=c.layoutOptions,p,l=[];if(k){this.legendAll=!1;k.legendLayers?q.forEach(k.legendLayers,function(b){var a={};a.id=b.layerId;b.subLayerIds&&(a.subLayerIds=b.subLayerIds);l.push(a)}):this.legendAll=!0;var g,r;if("Miles"===k.scalebarUnit||
"Kilometers"===k.scalebarUnit)g="esriKilometers",r="esriMiles";else if("Meters"===k.scalebarUnit||"Feet"===k.scalebarUnit)g="esriMeters",r="esriFeet";p={esriMiles:"mi",esriKilometers:"km",esriFeet:"ft",esriMeters:"m"};p={titleText:k.titleText,authorText:k.authorText,copyrightText:k.copyrightText,customTextElements:k.customTextElements,scaleBarOptions:{metricUnit:g,metricLabel:p[g],nonMetricUnit:r,nonMetricLabel:p[r]},legendOptions:{operationalLayers:l}}}g=this._getPrintDefinition(a.map,c);a.outSpatialReference&&
(g.mapOptions.spatialReference=a.outSpatialReference.toJson());a.template&&y.isDefined(a.template.showAttribution)&&(g.mapOptions.showAttribution=a.template.showAttribution);m.mixin(g,{exportOptions:f,layoutOptions:p});this.allLayerslegend&&m.mixin(g.layoutOptions,{legendOptions:{operationalLayers:this.allLayerslegend}});if(g.operationalLayers){f=g.operationalLayers;var n,v=function(b){return y.fixJson(m.mixin(b,{type:"esriSLS",cap:void 0,join:void 0,meterLimit:void 0}))};for(p=0;p<f.length;p++)if(f[p].featureCollection&&
f[p].featureCollection.layers)for(r=0;r<f[p].featureCollection.layers.length;r++){var t=f[p].featureCollection.layers[r];t.layerDefinition&&t.layerDefinition.drawingInfo&&t.layerDefinition.drawingInfo.renderer&&t.layerDefinition.drawingInfo.renderer.symbol&&(n=t.layerDefinition.drawingInfo.renderer,"esriCLS"===n.symbol.type?n.symbol=v(n.symbol):n.symbol.outline&&"esriCLS"===n.symbol.outline.type&&(n.symbol.outline=v(n.symbol.outline)));if(t.featureSet&&t.featureSet.features)for(k=0;k<t.featureSet.features.length;k++)n=
t.featureSet.features[k],n.symbol&&("esriCLS"===n.symbol.type?n.symbol=v(n.symbol):n.symbol.outline&&"esriCLS"===n.symbol.outline.type&&(n.symbol.outline=v(n.symbol.outline)))}}c={Web_Map_as_JSON:A.toJson(y.fixJson(g)),Format:c.format,Layout_Template:c.layout};a.extraParameters&&(c=m.mixin(c,a.extraParameters));var x=new D(F._dfdCanceller);a=function(a,c){b(a,c,e,h,x)};g=function(b){d(b,h,x)};x._pendingDfd=this.async?this.printGp.submitJob(c,a,null,g):this.printGp.execute(c,a,g);return x},onComplete:function(){},
_createMultipointLayer:function(){return{layerDefinition:{name:"multipointLayer",geometryType:"esriGeometryMultipoint",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryMultipoint",features:[]}}},_createPolygonLayer:function(){return{layerDefinition:{name:"polygonLayer",geometryType:"esriGeometryPolygon",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPolygon",features:[]}}},_createPointLayer:function(){return{layerDefinition:{name:"pointLayer",geometryType:"esriGeometryPoint",
drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPoint",features:[]}}},_createPolylineLayer:function(){return{layerDefinition:{name:"polylineLayer",geometryType:"esriGeometryPolyline",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPolyline",features:[]}}},_convertSvgSymbol:function(a){if(!(8>=B("ie")||!a.path&&"image/svg+xml"!==a.contentType)){var e,h=z.createSurface(P.create("div"),1024,1024);e="image/svg+xml"===a.contentType?h.createObject(z.Image,{src:"data:image/svg+xml;base64,"+
a.imageData,width:u.pt2px(a.width),height:u.pt2px(a.height),x:0,y:0}):h.createObject(z.Path,a.path).setFill(a.color).setStroke(a.outline);"pendingRender"in h&&h._render(!0);var b=h.rawNode.getContext("2d"),d=Math.ceil(e.getBoundingBox().width),c=Math.ceil(e.getBoundingBox().height);e=b.getImageData(e.getBoundingBox().x,e.getBoundingBox().y,d,c);b.canvas.width=d;b.canvas.height=c;b.putImageData(e,0,0);b=b.canvas.toDataURL("image/png");a={type:"esriPMS",imageData:b.substr(22,b.length),angle:a.angle,
contentType:"image/png",height:a.size?a.size:u.px2pt(c),width:a.size?d/c*a.size:u.px2pt(d),xoffset:a.xoffset,yoffset:a.yoffset};h.destroy();return a}},_convertSvgRenderer:function(a){"simple"===a.type&&a.symbol&&(a.symbol.path||"image/svg+xml"===a.symbol.contentType)?a.symbol=this._convertSvgSymbol(a.symbol):"uniqueValue"===a.type?(a.defaultSymbol&&(a.defaultSymbol.path||"image/svg+xml"===a.defaultSymbol.contentType)&&(a.defaultSymbol=this._convertSvgSymbol(a.defaultSymbol)),a.uniqueValueInfos&&q.forEach(a.uniqueValueInfos,
function(a){if(a.symbol.path||"image/svg+xml"===a.symbol.contentType)a.symbol=this._convertSvgSymbol(a.symbol)},this)):"classBreaks"===a.type&&(a.defaultSymbol&&(a.defaultSymbol.path||"image/svg+xml"===a.defaultSymbol.contentType)&&(a.defaultSymbol=this._convertSvgSymbol(a.defaultSymbol)),a.classBreakInfos&&q.forEach(a.classBreakInfos,function(a){if(a.symbol.path||"image/svg+xml"===a.symbol.contentType)a.symbol=this._convertSvgSymbol(a.symbol)},this))},_createFeatureCollection:function(a,e,h){var b=
this._createPolygonLayer(),d=this._createPolylineLayer(),c=this._createPointLayer(),k=this._createMultipointLayer(),f=this._createPointLayer();f.layerDefinition.name="textLayer";delete f.layerDefinition.drawingInfo;if("esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass)b.layerDefinition.name=d.layerDefinition.name=c.layerDefinition.name=k.layerDefinition.name=m.getObject("arcgisProps.title",!1,a)||a.name||a.id;var p=a.renderer&&"esri.renderer.SimpleRenderer"===
a.renderer.declaredClass;if(!a.renderer||a.renderer._compiledFunc||m.isFunction(a.renderer.attributeField))delete b.layerDefinition.drawingInfo,delete d.layerDefinition.drawingInfo,delete c.layerDefinition.drawingInfo,delete k.layerDefinition.drawingInfo;else{var l=a.renderer.toJson({useLegacyRotationProperties:!0});if("temporal"===l.type){var l={latestObservationRenderer:l.latestObservationRenderer,trackLinesRenderer:l.trackRenderer,observationAger:l.observationAger,renderer:l.observationRenderer},
g={};a._trackIdField&&(g.trackIdField=a._trackIdField);a._startTimeField&&(g.startTimeField=a._startTimeField);a._endTimeField&&(g.endTimeField=a._endTimeField);b.layerDefinition.drawingInfo=l;b.layerDefinition.timeInfo=g;d.layerDefinition.drawingInfo=l;d.layerDefinition.timeInfo=g;c.layerDefinition.drawingInfo=l;c.layerDefinition.timeInfo=g;k.layerDefinition.drawingInfo=l;k.layerDefinition.timeInfo=g}else b.layerDefinition.drawingInfo.renderer=l,d.layerDefinition.drawingInfo.renderer=l,c.layerDefinition.drawingInfo.renderer=
l,k.layerDefinition.drawingInfo.renderer=l}l=a.fields;l||!a.renderer||a.renderer._compiledFunc||m.isFunction(a.renderer.attributeField)||("esri.renderer.ClassBreaksRenderer"===a.renderer.declaredClass?(l=[{name:a.renderer.attributeField,type:"esriFieldTypeDouble"}],a.renderer.normalizationField&&l.push({name:a.renderer.normalizationField,type:"esriFieldTypeDouble"})):"esri.renderer.UniqueValueRenderer"===a.renderer.declaredClass&&(l=[{name:a.renderer.attributeField,type:"esriFieldTypeString"}],a.renderer.attributeField2&&
l.push({name:a.renderer.attributeField2,type:"esriFieldTypeString"}),a.renderer.attributeField3&&l.push({name:a.renderer.attributeField3,type:"esriFieldTypeString"})));l&&(b.layerDefinition.fields=l,d.layerDefinition.fields=l,c.layerDefinition.fields=l,k.layerDefinition.fields=l);var l=a.graphics.length,r;for(r=0;r<l;r++){var n=a.graphics[r];if(!1!==n.visible&&n.geometry){g=n.toJson();g.symbol&&g.symbol.outline&&g.symbol.outline.color&&g.symbol.outline.color[3]&&(g.symbol.outline.color[3]=255);if(a.renderer&&
!g.symbol&&(m.isFunction(a.renderer.attributeField)||a.renderer._compiledFunc||this._isFeatureCollectionRequired(a.renderer)||"esri.renderer.DotDensityRenderer"===a.renderer.declaredClass||h)){h=h||a.renderer;var v=null;try{v=h.getSymbol(n)}catch(t){}if(!v)continue;g.symbol=v.toJson();this._isFeatureCollectionRequired(h)&&this._applyVisualVariables(g.symbol,{renderer:h,graphic:n,symbol:v,mapResolution:e&&e.getResolutionInMeters(),mapScale:e&&e.getScale()})}g.symbol&&(g.symbol.path||"image/svg+xml"===
g.symbol.contentType?g.symbol=this._convertSvgSymbol(g.symbol):g.symbol.text&&delete g.attributes);switch(n.geometry.type){case "polygon":b.featureSet.features.push(g);break;case "polyline":d.featureSet.features.push(g);break;case "point":g.symbol&&g.symbol.text?f.featureSet.features.push(g):c.featureSet.features.push(g);break;case "multipoint":k.featureSet.features.push(g);break;case "extent":g.geometry=J.fromExtent(n.geometry).toJson(),b.featureSet.features.push(g)}}}e=[];0<b.featureSet.features.length&&
e.push(b);0<d.featureSet.features.length&&e.push(d);0<k.featureSet.features.length&&e.push(k);0<c.featureSet.features.length&&e.push(c);0<f.featureSet.features.length&&e.push(f);if(!e.length)return null;q.forEach(e,function(a){var b=q.every(a.featureSet.features,function(a){return a.symbol});if(p||b)q.forEach(a.featureSet.features,function(a){delete a.attributes}),delete a.layerDefinition.fields;b&&delete a.layerDefinition.drawingInfo});q.forEach(e,function(a){a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&
this._convertSvgRenderer(a.layerDefinition.drawingInfo.renderer)},this);return{id:a.id,opacity:a.opacity,minScale:a.minScale||0,maxScale:a.maxScale||0,featureCollection:{layers:e}}},_getPrintDefinition:function(a,e){var h={operationalLayers:this._createOperationalLayers(a,e)},b=this._vtlExtent||a.extent,d=a.spatialReference;this._vtlExtent=null;a.spatialReference._isWrappable()&&(b=b._normalize(!0),d=b.spatialReference);b={mapOptions:{showAttribution:a.showAttribution,extent:b.toJson(),spatialReference:d.toJson()}};
e.preserveScale&&m.mixin(b.mapOptions,{scale:e.outScale||a.getScale()});a.timeExtent&&m.mixin(b.mapOptions,{time:[a.timeExtent.startTime.getTime(),a.timeExtent.endTime.getTime()]});d={};m.mixin(d,b,h);return d},_createOperationalLayers:function(a,e){var h,b,d,c,k=[];this.allLayerslegend=this.legendAll?[]:null;this._vtlExtent=null;var f=q.map(a.layerIds,a.getLayer,a);a._mapImageLyr&&f.push(a._mapImageLyr);for(h=0;h<f.length;h++)if(b=f[h],b.loaded&&b.visible)switch(d=b.declaredClass,c={id:b.id,title:m.getObject("arcgisProps.title",
!1,b)||b.id,opacity:b.opacity,minScale:b.minScale||0,maxScale:b.maxScale||0},c=m.mixin(c,this._getUrlAndToken(b)),b.getNode()&&O.get(b.getNode(),"data-reference")&&(c._isRefLayer=!0),d){case "esri.layers.ArcGISDynamicMapServiceLayer":var p=[];d=!!b._params.layers;if(b._params.dynamicLayers)d=A.fromJson(b._params.dynamicLayers),q.forEach(d,function(a){p.push({id:a.id,name:a.name,layerDefinition:a});delete a.id;delete a.name;delete a.maxScale;delete a.minScale}),0===p.length&&(c.visibleLayers=[-1]);
else if(b.supportsDynamicLayers){if(d||b.layerDefinitions||b.layerTimeOptions){var l=b.createDynamicLayerInfosFromLayerInfos(),g=null;d&&(g=b.visibleLayers);var g=C._getVisibleLayers(l,g),r=C._getLayersForScale(e.outScale||a.getScale(),l);q.forEach(l,function(a){if(!a.subLayerIds){var c=a.id;-1<q.indexOf(g,c)&&-1<q.indexOf(r,c)&&(a={source:a.source.toJson()},b.layerDefinitions&&b.layerDefinitions[c]&&(a.definitionExpression=b.layerDefinitions[c]),b.layerTimeOptions&&b.layerTimeOptions[c]&&(a.layerTimeOptions=
b.layerTimeOptions[c].toJson()),p.push({id:c,layerDefinition:a}))}});0===p.length&&(c.visibleLayers=[-1])}}else q.forEach(b.layerInfos,function(a){var c={id:a.id,layerDefinition:{}};b.layerDefinitions&&b.layerDefinitions[a.id]&&(c.layerDefinition.definitionExpression=b.layerDefinitions[a.id]);b.layerTimeOptions&&b.layerTimeOptions[a.id]&&(c.layerDefinition.layerTimeOptions=b.layerTimeOptions[a.id].toJson());(c.layerDefinition.definitionExpression||c.layerDefinition.layerTimeOptions)&&p.push(c)}),
d&&(c.visibleLayers=b.visibleLayers);p.length&&(c.layers=p);k.push(c);this.allLayerslegend&&this.allLayerslegend.push({id:b.id,subLayerIds:b.visibleLayers});break;case "esri.layers.ArcGISImageServiceLayer":c=m.mixin(c,{url:b.url,bandIds:b.bandIds,compressionQuality:b.compressionQuality,format:b.format,interpolation:b.interpolation});b.mosaicRule&&m.mixin(c,{mosaicRule:b.mosaicRule.toJson()});(b.renderingRule||b.renderer)&&(d=b.getExportImageRenderingRule())&&m.mixin(c,{renderingRule:d.toJson()});
k.push(c);this.allLayerslegend&&this.allLayerslegend.push({id:b.id});break;case "esri.layers.WMSLayer":c=m.mixin(c,{url:b.url,title:b.title,type:"wms",version:b.version,transparentBackground:b.imageTransparency,visibleLayers:b.visibleLayers});k.push(c);this.allLayerslegend&&this.allLayerslegend.push({id:b.id,subLayerIds:b.visibleLayers});break;case "esri.virtualearth.VETiledLayer":d=b.mapStyle;"roadOnDemand"===d?d="Road":"aerialWithLabels"===d&&(d="Hybrid");c=m.mixin(c,{visibility:b.visible,type:"BingMaps"+
d,culture:b.culture,key:b.bingMapsKey});k.push(c);break;case "esri.layers.OpenStreetMapLayer":c=m.mixin(c,{credits:b.copyright,type:"OpenStreetMap",url:H.getAbsoluteUrl(b.tileServers[0])});k.push(c);break;case "esri.layers.WMTSLayer":c=m.mixin(c,{url:b.url,type:"wmts",layer:b._identifier,style:b._style,format:b.format,tileMatrixSet:b._tileMatrixSetId});k.push(c);break;case "esri.layers.MapImageLayer":d=b.getImages();q.forEach(d,function(a,d){a.href&&(c={id:b.id+"_image"+d,type:"image",title:b.id,
minScale:b.minScale||0,maxScale:b.maxScale||0,opacity:b.opacity*a.opacity,extent:a.extent.toJson()},"data:image/png;base64,"===a.href.substr(0,22)?c.imageData=a.href.substr(22):c.url=a.href,k.push(c))});break;case "esri.layers.VectorTileLayer":c.type="image";c.url&&delete c.url;d=this._vtlExtent||a.extent.offset(0,0);var n=e.exportOptions&&e.exportOptions.dpi||96,l={format:"png",pixelRatio:n/96};"MAP_ONLY"!==e.layout||!e.preserveScale||e.outScale&&e.outScale!==a.getScale()||96!==n||!e.exportOptions||
e.exportOptions.width%2===a.width%2&&e.exportOptions.height%2===a.height%2||(l.area={x:0,y:0,width:a.width,height:a.height},e.exportOptions.width%2!==a.width%2&&--l.area.width,e.exportOptions.height%2!==a.height%2&&--l.area.height,this._vtlExtent||(n=a.toMap({x:l.area.width,y:l.area.height}),d.update(d.xmin,n.y,n.x,d.ymax,d.spatialReference),this._vtlExtent=d));c.extent=d._normalize(!0).toJson();d=b.takeScreenshot(l);d.isResolved()?d.then(function(a){"data:image/png;base64,"===a.dataURL.substr(0,
22)&&(c.imageData=a.dataURL.substr(22))}):console.error("PrintTask: VectorTileLayer.takeScreenshot() returned an unresolved Promise");c.imageData&&k.push(c);break;case "esri.layers.WebTiledLayer":d=b.url.replace(/\$\{/g,"{");c=m.mixin(c,{type:"WebTiledLayer",urlTemplate:d,credits:b.copyright});b.subDomains&&0<b.subDomains.length&&(c.subDomains=b.subDomains);b._wmtsInfo&&(c.wmtsInfo=b._wmtsInfo);delete c.url;k.push(c);break;default:if(b.getTileUrl||b.getImageUrl)c=m.mixin(c,{url:b.url}),k.push(c)}for(h=
0;h<a.graphicsLayerIds.length;h++)if(b=a.getLayer(a.graphicsLayerIds[h]),b.loaded&&b.visible)switch(d=b.declaredClass,d){case "esri.layers.FeatureLayer":case "esri.layers.LabelLayer":case "esri.layers.CSVLayer":case "esri.layers.StreamLayer":if("esri.layers.LabelLayer"===d&&!e.showLabels||b.renderer&&"esri.renderer.HeatmapRenderer"===b.renderer.declaredClass)continue;f=null;b.url&&b.renderer&&("esri.renderer.ScaleDependentRenderer"===b.renderer.declaredClass?"scale"===b.renderer.rangeType?f=b.renderer.getRendererInfoByScale(a.getScale())&&
b.renderer.getRendererInfoByScale(a.getScale()).renderer:"zoom"===b.renderer.rangeType&&(f=b.renderer.getRendererInfoByZoom(a.getZoom())&&b.renderer.getRendererInfoByZoom(a.getZoom()).renderer):f=b.renderer);if(f&&("esri.renderer.SimpleRenderer"===f.declaredClass||"esri.renderer.TemporalRenderer"===f.declaredClass||m.isString(f.attributeField)&&b._getField(f.attributeField,!0))&&!f._compiledFunc&&!this._isFeatureCollectionRequired(f)&&"esri.renderer.DotDensityRenderer"!==f.declaredClass&&"esri.layers.CSVLayer"!==
b.declaredClass&&"esri.layers.StreamLayer"!==b.declaredClass)if(c={id:b.id,title:m.getObject("arcgisProps.title",!1,b)||b.id,opacity:b.opacity,minScale:b.minScale||0,maxScale:b.maxScale||0,layerDefinition:{drawingInfo:{renderer:f.toJson({useLegacyRotationProperties:!0})}}},c=m.mixin(c,this._getUrlAndToken(b)),"esri.renderer.TemporalRenderer"===f.declaredClass&&(d=c.layerDefinition.drawingInfo,d.latestObservationRenderer=d.renderer.latestObservationRenderer,d.trackLinesRenderer=d.renderer.trackRenderer,
d.observationAger=d.renderer.observationAger,d.renderer=d.renderer.observationRenderer,b._trackIdField&&(c.layerDefinition.timeInfo={trackIdField:b._trackIdField})),this._convertSvgRenderer(c.layerDefinition.drawingInfo.renderer),1>b.opacity||"esri.renderer.TemporalRenderer"===f.declaredClass||this._updateLayerOpacity(c))if(b._params.source&&(f=b._params.source.toJson(),m.mixin(c.layerDefinition,{source:f})),b.getDefinitionExpression()&&m.mixin(c.layerDefinition,{definitionExpression:b.getDefinitionExpression()}),
2!==b.mode)0<b.getSelectedFeatures().length&&(f=q.map(b.getSelectedFeatures(),function(a){return a.attributes[b.objectIdField]}),0<f.length&&b.getSelectionSymbol()&&m.mixin(c,{selectionObjectIds:f,selectionSymbol:b.getSelectionSymbol().toJson()}));else{f=q.map(b.getSelectedFeatures(),function(a){return a.attributes[b.objectIdField]});if(0===f.length||!b._params.drawMode)break;m.mixin(c.layerDefinition,{objectIds:f});f=null;b.getSelectionSymbol()&&(f=new K(b.getSelectionSymbol()));m.mixin(c.layerDefinition.drawingInfo,
{renderer:f&&f.toJson()})}else c=this._createFeatureCollection(b,a);else c=f&&(f._compiledFunc||this._isFeatureCollectionRequired(f)||"esri.renderer.DotDensityRenderer"===f.declaredClass)?this._createFeatureCollection(b,a,f):this._createFeatureCollection(b,a);if(!c)continue;k.push(c);this.allLayerslegend&&this.allLayerslegend.push({id:b.id});break;case "esri.layers.GraphicsLayer":case "esri.layers.WFSLayer":if(c=this._createFeatureCollection(b,a))k.push(c),this.allLayerslegend&&this.allLayerslegend.push({id:b.id})}a.graphics&&
0<a.graphics.graphics.length&&(c=this._createFeatureCollection(a.graphics,a))&&k.push(c);a._labels&&e.showLabels&&(c=this._createFeatureCollection(a._labels,a))&&k.push(c);q.forEach(k,function(a,b,c){a._isRefLayer&&(delete a._isRefLayer,c.splice(b,1),c.push(a))});return k},_getUrlAndToken:function(a){return{token:a._getToken(),url:a._url?a._url.path:null}},_updateLayerOpacity:function(a){var e=this._colorEvaluator(a),e=q.filter(e,function(a){return m.isArray(a)&&4===a.length}),h=!0;if(e.length){var b=
e[0][3],d;for(d=1;d<e.length;d++)if(b!==e[d][3]){h=!1;break}if(h)for(a.opacity=b/255,d=0;d<e.length;d++)e[d][3]=255}return h},_isFeatureCollectionRequired:function(a){var e=!1,h=this._getVariable(a,"rotationInfo",!1);h&&(e=(e=h.field)&&m.isFunction(e)||h.valueExpression);return a.hasVisualVariables("sizeInfo")||a.hasVisualVariables("colorInfo")||a.hasVisualVariables("opacityInfo")||e},_getVariable:function(a,e,h){var b;a&&(b=(a=a.getVisualVariablesForType(e,h))&&a[0]);return b},_applyVisualVariables:function(a,
e){var h=e.renderer,b=e.graphic,d=e.symbol,c=e.mapResolution,k=e.mapScale,f=d.type;if("textsymbol"!==f&&"shieldlabelsymbol"!==f){var m=this._getVariable(h,"sizeInfo",!1),l=this._getVariable(h,"colorInfo",!1),g=this._getVariable(h,"opacityInfo",!1),q=this._getVariable(h,"rotationInfo",!1);d instanceof L&&(m=this._getVariable(h,"sizeInfo","outline")||m);m&&(d=h.getSize(b,{sizeInfo:m,shape:"simplemarkersymbol"===f?d.style:null,resolution:c,scale:k}),null!=d&&("simplemarkersymbol"===f?a.size=u.px2pt(d):
"picturemarkersymbol"===f?(a.width=u.px2pt(d),a.height=u.px2pt(d)):"simplelinesymbol"===f?a.width=u.px2pt(d):a.outline&&(a.outline.width=u.px2pt(d))));l&&(!(l=h.getColor(b,{colorInfo:l}))||"simplemarkersymbol"!==f&&"simplelinesymbol"!==f&&"simplefillsymbol"!==f||(a.color=G.toJsonColor(l)));g&&(f=h.getOpacity(b,{opacityInfo:g}),null!=f&&a.color&&(a.color[3]=Math.round(255*f)));q&&(h=h.getRotationAngle(b,{rotationInfo:q}))&&(a.angle=-h)}}});B("extend-esri")&&m.setObject("tasks.PrintTask",w,E);return w});