// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.
//>>built
define("esri/layers/clustering/GeohashAggregation","dojo/has dojo/_base/declare dojo/_base/lang dojo/_base/array ../../kernel ../../Evented ../../geometry/Point ../../geometry/mathUtils ./geohashUtils".split(" "),function(n,m,h,e,p,q,r,t,l){m=m(q,{loaded:!1,map:null,layer:null,lod:null,tolerance:null,maxLod:null,clusterMode:null,clusterSize:null,sortEnabled:!0,filterEnabled:!0,bufferEnabled:!0,updateEnabled:!0,clusters:null,clustersEnabled:!0,statisticInfos:null,defaults:{lod:1,tolerance:0,clusterMode:"auto",
clusterSize:80,sortEnabled:!0,filterEnabled:!0,bufferEnabled:!0,updateEnabled:!0},_eventHandles:null,_updateHandle:null,_cellIndex:null,_globalIndex:null,_perfProfile:null,_maxGeohashLength:12,_minClusterSize:15,_active:!1,_levelChange:!0,_modeChange:!1,constructor:function(a){this._update=h.hitch(this,this._update);this._eventHandles=[];this._globalIndex={numFeatures:null,fullExtent:null,lodStats:null};this._perfProfile={lastIndex:{total:null,numFeatures:0},lastUpdate:{cells:null,clusters:null,total:null}};
this.clusters=[];this.map=a.map;this.layer=a.layer;this.setLod(a.lod);this.setTolerance(a.tolerance);this.setClusterMode(a.clusterMode);this.setClusterSize(a.clusterSize);this.setSortEnabled(a.sortEnabled);this.setFilterEnabled(a.filterEnabled);this.setBufferEnabled(a.bufferEnabled);this.setUpdateEnabled(a.updateEnabled);this.setStatisticInfos(a.statisticInfos);this._load();this.loaded?this._startup():this._eventHandles.push(this.on("load",h.hitch(this,this._startup)))},destroy:function(){this._displayFeatures(!0);
e.forEach(this._eventHandles,function(a){a.remove()});clearTimeout(this._updateHandle);this._cellIndex=this._globalIndex=this._eventHandles=this._updateHandle=this.map=this.layer=this.clusters=null},setLod:function(a){var b=this.lod;this.lod=a||this.defaults.lod;b!==this.lod&&this.update()},setTolerance:function(a){var b=this.tolerance;this.tolerance=a||this.defaults.tolerance;b!==this.tolerance&&this.update()},setClusterMode:function(a){var b=this.clusterMode;this.clusterMode=a||this.defaults.clusterMode;
this._evalClusterParams();b!==this.clusterMode&&this.update()},setClusterSize:function(a){var b=this.clusterSize;this.clusterSize=null!=a?a:this.defaults.clusterSize;this._evalClusterParams();b!==this.clusterSize&&this.update()},setSortEnabled:function(a){var b=this.sortEnabled;this.sortEnabled=null!=a?!!a:this.defaults.sortEnabled;b!==this.sortEnabled&&this.update()},setFilterEnabled:function(a){var b=this.filterEnabled;this.filterEnabled=null!=a?!!a:this.defaults.filterEnabled;b!==this.filterEnabled&&
this.update()},setBufferEnabled:function(a){var b=this.bufferEnabled;this.bufferEnabled=null!=a?!!a:this.defaults.bufferEnabled;b!==this.bufferEnabled&&this.update()},setUpdateEnabled:function(a){var b=this.updateEnabled;(this.updateEnabled=null!=a?!!a:this.defaults.updateEnabled)&&b!==this.updateEnabled&&this.update()},setStatisticInfos:function(a){this.statisticInfos=a||[];this.loaded&&this._applyStatInfos(this.statisticInfos)},update:function(){this.loaded&&null==this._updateHandle&&(this._updateHandle=
setTimeout(this._update,0))},isUpdateScheduled:function(){return null!=this._updateHandle},getCell:function(a){return this._cellIndex[a.length][a]},getCluster:function(a){var b;e.some(this.clusters,function(c){-1<e.indexOf(c.geohashes,a)&&(b=c);return!!b});return b},getCellsInCluster:function(a){var b=[];e.forEach(a&&a.geohashes,function(a){(a=this.getCell(a))&&b.push(a)},this);return b},getCurrentLodStats:function(){var a=this._globalIndex.lodStats;return a&&a[this.lod]},_load:function(){this._displayFeatures(!1);
this._checkLoadStatus();this.map.loaded||this._eventHandles.push(this.map.on("load",h.hitch(this,this._checkLoadStatus)));this.layer.loaded||this._eventHandles.push(this.layer.on("load",h.hitch(this,this._checkLoadStatus)))},_checkLoadStatus:function(){if(this.map.loaded&&this.layer.loaded){var a;if("esriGeometryPoint"!==this.layer.geometryType)a=Error("GeohashAggregation is supported only for points");else{var b=this.map.spatialReference;b.isWebMercator()||4326===b.wkid||(a=Error("GeohashAggregation is supported only when map spatial reference is WGS84 or WebMercator"))}a?
(this.loadError=a,this.emit("load-error",{error:a})):(this.loaded=!0,this.emit("load"))}},_startup:function(){this._evalUpdateStatus();this._processFeatures();this._processExtentChange();this._eventHandles.push(this.layer.on("update-end",h.hitch(this,this._processFeatures)),this.layer.on("suspend",h.hitch(this,this._evalUpdateStatus)),this.layer.on("resume",h.hitch(this,this._evalUpdateStatus)),this.map.on("extent-change",h.hitch(this,this._processExtentChange)))},_processFeatures:function(){this._indexFeatures();
this.update()},_evalUpdateStatus:function(){this.setUpdateEnabled(!this.layer.suspended)},_processExtentChange:function(){this._evalClusterParams();this.update()},_update:function(){this._updateHandle=null;if(this.updateEnabled){this.emit("update-start");this._evalClustersEnabled();if(this.clustersEnabled){var a=this.map.geographicExtent;if(a){var b=this._getIntersectingCells(a),a=this._getClusters(b.cells,a);this.clusters=a.clusters;this._applyStatInfosToClusters(this._getStatFields(this.statisticInfos));
var b=b.profile,a=a.profile,c=b.total+a.total;b.total=this._getElapsedTime(b.total);a.total=this._getElapsedTime(a.total);var d=this._perfProfile.lastUpdate={};d.cells=b;d.clusters=a;d.total=this._getElapsedTime(c)}}else this.clusters=[],this._perfProfile.lastUpdate=null;this.emit("update-end",{levelChange:this._levelChange,modeChange:this._modeChange});this._modeChange&&this.emit("mode-change")}},_evalClustersEnabled:function(){var a=this.clustersEnabled;(this.clustersEnabled=!(null!=this.maxLod&&
this.lod>this.maxLod))&&!this._active&&(this._active=!0);this._modeChange=!1;!this._active||a===this.clustersEnabled&&this.layer._params.drawMode!==this.clustersEnabled||(this._modeChange=!0,this._displayFeatures(!this.clustersEnabled))},_displayFeatures:function(a){var b=this.layer;b.setDrawMode(a);a?b.redraw():b.clearNodes()},_indexFeatures:function(){var a=this._getTime();this._initializeIndexing();var b=0,c=this._globalIndex.fullExtent;e.forEach(this.layer.graphics,function(a){var d=this._getLngLat(a.geometry),
f;d&&(f=l.pointToGeohash(d));f&&(this._addGeohashToIndex(f,a,d),b++,this._updateExtent(c,d))},this);this._applyStatInfosToIndex(this._getStatFields(this.statisticInfos));this._globalIndex.numFeatures=b;for(var d=this._globalIndex.lodStats,f=1;f<=this._maxGeohashLength;f++)d[f]=this._getLODStats(f,b);this.maxLod=b?this._findMaxLOD(d):null;this._perfProfile.lastIndex.total=this._getElapsedTime(a,this._getTime());this._perfProfile.lastIndex.numFeatures=b;this.emit("index-complete")},_initializeIndexing:function(){this._globalIndex=
{numFeatures:0,fullExtent:{xmin:Infinity,ymin:Infinity,xmax:-Infinity,ymax:-Infinity},lodStats:{}};for(var a=this._cellIndex=[],b=1;b<=this._maxGeohashLength;b++)a[b]={}},_getLngLat:function(a){if(a){var b=a.getLongitude();a=a.getLatitude();a=null!=b&&null!=a?{x:b,y:a}:null}return a},_addGeohashToIndex:function(a,b,c){for(var d=this._cellIndex,f="",g=0;g<this._maxGeohashLength;g++){var f=f+a[g],k=d[f.length],e=k[f];e||(e=k[f]={count:0,centroid:{x:null,y:null},extent:{xmin:Infinity,ymin:Infinity,xmax:-Infinity,
ymax:-Infinity},features:[],geohash:f,statistics:null});this._updateItem(e,1,c,!0);e.features.push(b)}},_getLODStats:function(a,b){var c=this._cellIndex[a],d=0,f=Infinity,g=-Infinity,k=null,e;for(e in c){var h=c[e];d++;h.count<f&&(f=h.count);h.count>g&&(g=h.count)}0<d&&(k=Number((b/d).toFixed(2)));return{lod:a,count:d,min:Infinity===f?null:f,max:-Infinity===g?null:g,avg:k}},_findMaxLOD:function(a){for(var b=this._maxGeohashLength;1<b&&a[b].count===a[b-1].count;)b--;return b-1},_evalClusterParams:function(){if(this.loaded&&
"auto"===this.clusterMode){var a=this._getClusterParams(this.map.getResolutionInMeters(),this.clusterSize,this._minClusterSize);this._levelChange=this.lod!==a.lod;this.lod=a.lod;this.tolerance=a.tolerance}},_getClusterParams:function(a,b,c){b<c&&(b=c);c=Math.ceil(a*b);a=this._getClosestLODRange(c).max;var d;do d=this._getCellSize(a),b=c-d,(d=b>d||1===d)||(a+=1);while(!d);c=b/this._getCellSize(a);return{lod:a,tolerance:b,multiplier:Number(c.toFixed(2))}},_getClosestLODRange:function(a){for(var b,c=
this._maxGeohashLength;1<=c;c--)if(this._getCellSize(c)>=a){b=c;break}null==b&&(b=1);a=b+1;a>this._maxGeohashLength&&(a=this._maxGeohashLength);return{min:b,max:a}},_getCellSize:function(a){a=l.getCellSizeInMeters(a);return Math.ceil(Math.min(a.width,a.height))},_sorter:function(a,b){var c=a.centroid,d=b.centroid;return a.count>b.count?-1:a.count<b.count?1:c.x>d.x?-1:c.x<d.x?1:0},_getIntersectingCells:function(a){var b=this._getTime(),c=l.getIntersecting(a,this.lod,this.bufferEnabled?this.tolerance:
0);a=this._getTime();var d=[],f=this.tolerance,g=this.sortEnabled;e.forEach(c,function(a){(a=this.getCell(a))&&d.push(a)},this);f&&g&&d.sort(this._sorter);c=this._getTime();return{cells:d,profile:{findCells:this._getElapsedTime(b,a),scanAndSortCells:this._getElapsedTime(a,c),total:c-b}}},_getClusters:function(a,b){var c=this._getTime(),d=[],f={},g={findCells:0};e.forEach(a,function(a,b){var c=this._createCluster(a,f,g);c&&d.push(c)},this);this._markIntersecting(d,b);this.filterEnabled&&(d=this._getIntersectingClusters(d));
var k=this._getTime();return{clusters:d,profile:{findCellsInCluster:this._getElapsedTime(g.findCells),total:k-c}}},_markIntersecting:function(a,b){var c=b.normalize();e.forEach(a,function(a){var b=a.centroid.x,d=a.centroid.y;a.isIntersecting=e.some(c,function(a){return b>=a.xmin&&b<=a.xmax&&d>=a.ymin&&d<=a.ymax})})},_getIntersectingClusters:function(a){return e.filter(a,function(a){return a.isIntersecting})},_createCluster:function(a,b,c){if(!b[a.geohash]){var d=[{cell:a,distance:0}];if(this.tolerance){var f=
this._getTime(),g=l.getNeighborsWithinDistance(a.centroid,this.lod,this.tolerance);c.findCells+=this._getTime()-f;e.forEach(g,function(b){if(b!==a.geohash&&(b=this.getCell(b))){var c=this._calculateDistance(a.centroid,b.centroid);c<=this.tolerance&&d.push({cell:b,distance:c})}},this)}return this._mergeCells(d,b)}},_calculateDistance:function(a,b){return t.getLength(l.geographicToWebMercator(a),l.geographicToWebMercator(b))},_mergeCells:function(a,b){var c=this._initializeCluster({},a[0].cell.geohash);
e.forEach(a,function(a){var d=a.cell,g=d.geohash;a=a.distance;var e=b[g];if(e)if(a<e.distance)this._removeCellFromCluster(g,b);else return;b[g]={cluster:c,distance:a};this._updateItem(c,d.count,d.centroid);c.geohashes.push(g)},this);return c},_removeCellFromCluster:function(a,b){var c=b[a].cluster;delete b[a];var d=e.indexOf(c.geohashes,a);-1<d&&c.geohashes.splice(d,1);this._reevaluateCluster(c)},_reevaluateCluster:function(a){var b=a.geohashes;a=this._initializeCluster(a,a.primary);e.forEach(b,function(b){var c=
this.getCell(b);c&&(this._updateItem(a,c.count,c.centroid),a.geohashes.push(b))},this)},_initializeCluster:function(a,b){a.count=0;a.centroid=new r(null,null);a.geohashes=[];a.primary=b;a.statistics=null;return a},_applyStatInfos:function(a){a=this._getStatFields(a);this._applyStatInfosToIndex(a);this._applyStatInfosToClusters(a)},_getStatFields:function(a){a=this._getValidStatInfos(a);var b=[];e.forEach(a,function(a){-1===e.indexOf(b,a.field)&&b.push(a.field)});return b},_getValidStatInfos:function(a){var b=
this.layer;return e.filter(a,function(a){return b.loaded&&b.isOutField(a.field)&&("sum"===a.type||"avg"===a.type)})},_applyStatInfosToIndex:function(a){var b=this._cellIndex;if(b)for(var c=1;c<=this._maxGeohashLength;c++){var d=b[c],f;for(f in d)this._applyStatInfosToCell(d[f],a)}},_applyStatInfosToCell:function(a,b){var c=this._initializeStats(a,b);e.forEach(a.features,function(a){this._calcFeatureStats(a,b,c)},this);this._summarizeStats(a,c,b)},_calcFeatureStats:function(a,b,c){var d=a.attributes;
d&&e.forEach(b,function(a){var b=d[a];a=c[a];this._isValidNumber(b)&&(a.count++,a.sum+=b)},this)},_applyStatInfosToClusters:function(a){e.forEach(this.clusters,function(b){var c=this._initializeStats(b,a);e.forEach(this.getCellsInCluster(b),function(b){this._calcCellStats(b,a,c)},this);this._summarizeStats(b,c,a);b.attributes.clusterId=b.primary},this)},_calcCellStats:function(a,b,c){var d=a.statistics;e.forEach(b,function(a){var b=d[a];a=c[a];b.count&&(a.count+=b.count,a.sum+=b.sum)})},_initializeStats:function(a,
b){var c=a.statistics={};e.forEach(b,function(a){c[a]={count:0,sum:null,avg:null}});return c},_summarizeStats:function(a,b,c){var d=a.attributes={count:a.count};e.forEach(c,function(a){var c=b[a];0<c.count&&(c.avg=c.sum/c.count);d["sum_"+a]=c.sum;d["avg_"+a]=c.avg})},_updateItem:function(a,b,c,d){var e=c.y,g=a.centroid,h=a.count;g.x=(h*g.x+b*c.x)/(h+b);g.y=(h*g.y+b*e)/(h+b);a.count+=b;d&&this._updateExtent(a.extent,c)},_updateExtent:function(a,b){var c=b.x,d=b.y;c<a.xmin&&(a.xmin=c);c>a.xmax&&(a.xmax=
c);d<a.ymin&&(a.ymin=d);d>a.ymax&&(a.ymax=d)},_isValidNumber:function(a){return"number"===typeof a&&!isNaN(a)&&Infinity!==a&&-Infinity!==a},_getTime:function(){return window.performance?window.performance.now():(new Date).getTime()},_getElapsedTime:function(a,b){var c,d;d=null!=a&&null!=b?b-a:a;null!=d&&(c="millisecond",1E3<=d&&(d/=1E3,c="second",60<=d&&(d/=60,c="minute")),c={value:Number(d.toFixed(2)),unit:c});return c}});n("extend-esri")&&h.setObject("layers.clustering.GeohashAggregation",m,p);
return m});