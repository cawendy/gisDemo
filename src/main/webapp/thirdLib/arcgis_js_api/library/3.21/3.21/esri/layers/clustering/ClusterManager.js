// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.
//>>built
define("esri/layers/clustering/ClusterManager","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../../kernel ../../Evented ../../graphic ../../dijit/PopupTemplate ../../dijit/Legend/utils ../../renderers/SimpleRenderer ../../symbols/SimpleMarkerSymbol ../GraphicsLayer ./GeohashAggregation".split(" "),function(g,f,e,k,l,m,n,p,q,r,t,u,v){g=g(m,{declaredClass:"esri.layers.clustering.ClusterManager",layer:null,aggregationInfo:null,container:null,defaults:{clusterSize:80,markerSymbol:{color:[77,
77,77,255],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:.75,type:"esriSLS",style:"esriSLSSolid"}}},_map:null,_eventHandles:null,_clusterSize:null,_renderer:null,_statisticInfos:null,_infoTemplate:null,_clusterGenerator:null,constructor:function(a){this._eventHandles=[];this.layer=a.layer;this.setAggregationInfo(a.aggregationInfo)},initialize:function(a){this._map=a;this.container=this._createContainer();this._clusterGenerator=this._createClusterGenerator();
this._initClusterGenerator();this._createLayerEventListeners();this._createMapEventListeners()},destroy:function(){this._destroyEventListeners();this._destroyClusterGenerator();this._destroyContainer();this.layer=this.aggregationInfo=this._map=null},setAggregationInfo:function(a){this.aggregationInfo=a;this._applyAggregationInfo()},getClusterRenderer:function(){return this._renderer},redraw:function(){this.container&&this.container.redraw()},isClusteringEnabled:function(){return this._clusterGenerator&&
this._clusterGenerator.clustersEnabled},_createContainer:function(){var a=this.layer,c=new u._GraphicsLayer({_child:!0,id:a.id+"_clusters",visible:a.visible,minScale:a.minScale,maxScale:a.maxScale,infoTemplate:this._infoTemplate});c.setRenderer(this._renderer);c.loaded=!0;c.onLoad(c);c._setMap(this._map,a._div);return a._childLayer=c},_destroyContainer:function(){var a=this.container;a&&(a.clear(),a._unsetMap(this._map,this.layer._div),this.layer._childLayer=null);this.container=null},_createClusterGenerator:function(){return new v({map:this._map,
layer:this.layer,clusterSize:this._clusterSize,statisticInfos:this._statisticInfos})},_initClusterGenerator:function(){var a=this._clusterGenerator;a.loaded?(this._applyRenderer(),this._initClusterUpdates()):this._eventHandles.push(a.on("load",f.hitch(this,function(){this._applyRenderer();this._initClusterUpdates()})),a.on("load-error",f.hitch(this,function(a){console.log(a.error)})));this._eventHandles.push(a.on("mode-change",f.hitch(this,function(){this.emit("mode-change")})))},_destroyClusterGenerator:function(){this._clusterGenerator&&
this._clusterGenerator.destroy();this._clusterGenerator=null},_applyAggregationInfo:function(){this._applyClusterSize();this._applyRenderer();this._clusterGenerator&&!this._clusterGenerator.isUpdateScheduled()&&this.redraw()},_applyClusterSize:function(){var a=this.aggregationInfo;this._clusterSize=a&&a.clusterSize||this.defaults.clusterSize;this._clusterGenerator&&this._clusterGenerator.setClusterSize(this._clusterSize)},_applyRenderer:function(){this._renderer=this._getRenderer(this.aggregationInfo,
"avg");this._statisticInfos=this._createStatisticInfos(this._renderer,"avg");this._clusterGenerator&&this._clusterGenerator.setStatisticInfos(this._statisticInfos);this.container&&(this.container.setRenderer(this._renderer),this.emit("renderer-change"),e.forEach(this.container.graphics,function(a){a.setAttributes(a._cluster.attributes)}));this._applyInfoTemplate()},_applyInfoTemplate:function(){this._infoTemplate=this._getInfoTemplate(this.aggregationInfo,this._statisticInfos);this.container&&this.container.setInfoTemplate(this._infoTemplate)},
_getRenderer:function(a,c){var b=a&&a.renderer;b||(b=(b=this.layer&&this.layer.renderer)?this._createClusterRenderer(b,c):this._getDefaultClusterRenderer());return b},_getDefaultClusterRenderer:function(){var a=new r(new t(this.defaults.markerSymbol));this._addSizeByCountVariable(a);return a},_createClusterRenderer:function(a,c){if(!this._isSupportedRenderer(a))return this._getDefaultClusterRenderer();var b=new a.constructor(a.toJson()),d=c+"_";b.attributeField=d+b.attributeField;b.normalizationField&&
(b.normalizationField=d+b.normalizationField);b.setVisualVariables(null);var d=this._getSupportedVariables(a),h=this._createClusterVariables(d.allVars,c);b.setVisualVariables(h);d.sizeVars.length||this._addSizeByCountVariable(b);return b},_isSupportedRenderer:function(a){var c=a.declaredClass.toLowerCase();return-1<c.indexOf("simplerenderer")?!0:-1<c.indexOf("classbreaksrenderer")?a.valueExpression?!1:a.isContinuousRenderer():!1},_getSupportedVariables:function(a){var c=a.getVisualVariablesForType("colorInfo",
!1)||[],b=a.getVisualVariablesForType("sizeInfo",!1)||[];a=a.getVisualVariablesForType("opacityInfo",!1)||[];c=e.filter(c,this._variableFilter);b=e.filter(b,this._variableFilter);a=e.filter(a,this._variableFilter);return{colorVars:c,sizeVars:b,opacityVars:a,allVars:c.concat(b).concat(a)}},_variableFilter:function(a){return"string"===typeof a.field},_createClusterVariables:function(a,c){return e.map(a,function(a){return this._createVarForAvg(a,c)},this)},_createVarForAvg:function(a,c){var b=f.clone(a),
d=c+"_";b.field=d+b.field;b.normalizationField&&(b.normalizationField=d+b.normalizationField);this._setVariableTitle(b,a);return b},_setVariableTitle:function(a,c){a.legendOptions&&a.legendOptions.title||(a.legendOptions=a.legendOptions||{},a.legendOptions.title=q.getVisualVariableTitle(c,this.layer))},_createStatisticInfos:function(a,c){if(-1!==a.declaredClass.toLowerCase().indexOf("classbreaksrenderer")){var b=[a.attributeField,a.normalizationField];e.forEach(a.visualVariables,function(a){"count"!==
a.field&&(b.push(a.field),b.push(a.normalizationField))});b=e.filter(b,function(a){return!!a});b.sort();var b=e.filter(b,function(a,c){return 0===c||b[c-1]!==a}),d=c+"_";return e.map(b,function(a){return{field:a.replace(d,""),type:c}})}},_addSizeByCountVariable:function(a){var c=this._createSizeByCountVariable();c&&this._addVariable(a,c)},_getSizeByCountVariable:function(a){a=a.getVisualVariablesForType("sizeInfo",!1)||[];return e.filter(a,function(a){return"count"===a.field})[0]},_updateSizeByCountVariable:function(){var a=
this._renderer,c=this._getSizeByCountVariable(a);if(c){var b=this._createSizeByCountVariable();b&&this._replaceVariable(a,c,b)}else this._addSizeByCountVariable(a)},_createSizeByCountVariable:function(){var a=this._clusterGenerator,c;a&&(a=a.getCurrentLodStats(),c={type:"sizeInfo",field:"count",valueUnit:"unknown",minSize:8,maxSize:50,minDataValue:a.min,maxDataValue:a.max,legendOptions:{title:"Number of features"}});return c},_addVariable:function(a,c){var b=a.visualVariables||[];b.push(c);a.setVisualVariables(b)},
_replaceVariable:function(a,c,b){var d=a.visualVariables;c=e.indexOf(d,c);-1<c&&d.splice(c,1);d.push(b);a.setVisualVariables(d)},_getInfoTemplate:function(a,c){var b=a&&a.infoTemplate;if(!b){var d=this.layer,h=[{fieldName:"count",visible:!0,label:"Number of features",format:{digitSeparator:!0,places:0}}],f=[];e.forEach(c,function(a){var b=a.type+"_"+a.field;h.push({fieldName:b,visible:!0,label:"Average "+d.getFieldLabel(a.field),format:{digitSeparator:!0,places:1}});f.push("Average \x3cb\x3e"+d.getFieldLabel(a.field)+
"\x3c/b\x3e within this cluster is \x3cb\x3e{"+b+"}\x3c/b\x3e.\x3cbr\x3e")});b=f.length?"\x3cbr\x3e"+f.join(""):"";b=new p({fieldInfos:h,description:"This cluster represents \x3cb\x3e{count}\x3c/b\x3e features.\x3cbr\x3e"+b})}return b},_removeFromPopup:function(a){var c=this._map.infoWindow,b=c.features,d=[];e.forEach(b,function(b,c){b.getLayer()===a&&d.push(c)});d.length&&(d.sort(function(a,b){return b-a}),b=b.slice(0),e.forEach(d,function(a){b.splice(a,1)}),c.setFeatures(b),b.length||c.hide())},
_initClusterUpdates:function(){this._updateClusters(!0,!1);this._eventHandles.push(this._clusterGenerator.on("update-end",f.hitch(this,function(a){this._updateClusters(a.levelChange,a.modeChange)})))},_updateClusters:function(a,c){this.isClusteringEnabled()&&c&&this._removeFromPopup(this.layer);var b=e.map(this._clusterGenerator.clusters,function(a){var b=new n(a.centroid,null,a.attributes);b._cluster=a;return b});this._addGraphics(b,a)},_addGraphics:function(a,c){var b=this.container;b.clear();var d=
this.aggregationInfo&&this.aggregationInfo.renderer;c&&this.isClusteringEnabled()&&this._renderer!==d&&(this._updateSizeByCountVariable(),this.emit("renderer-change"));e.forEach(a,function(a){b.add(a)})},_createLayerEventListeners:function(){var a=this.layer;this._eventHandles.push(a.on("visibility-change",f.hitch(this,function(a){this.container.setVisibility(a.visible);this.container.evaluateSuspension()})),a.on("scale-range-change",f.hitch(this,function(){this.container.setScaleRange(this.layer.minScale,
this.layer.maxScale)})),a.on("renderer-change",f.hitch(this,function(){this._applyRenderer()})))},_createMapEventListeners:function(){this._eventHandles.push(this._map.on("zoom-start",f.hitch(this,function(a){this.isClusteringEnabled()&&this._removeFromPopup(this.container);this.container.clear()})))},_destroyEventListeners:function(){e.forEach(this._eventHandles,function(a){a.remove()})}});k("extend-esri")&&f.setObject("layers.clustering.ClusterManager",g,l);return g});